<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILC Audio Recorder - Templates</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">ILC Audio Recorder</h1>
            <div class="space-x-4">
                <a href="/" class="hover:underline">Dashboard</a>
                <a href="/schedule" class="hover:underline">Schedule</a>
                <a href="/calendar" class="hover:underline">Calendar</a>
                <a href="/recordings" class="hover:underline">Recordings</a>
                <a href="/templates" class="hover:underline font-semibold">Templates</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Create/Edit Template Form -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4" id="form-title">Create Template</h2>

                <form id="template-form" class="space-y-4">
                    <input type="hidden" id="template-id" value="">

                    <!-- Template Name -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Template Name *</label>
                        <input type="text" id="template-name" required
                               class="w-full border rounded px-3 py-2"
                               placeholder="My Recording Template">
                    </div>

                    <!-- Duration -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Duration *</label>
                        <select id="template-duration" class="w-full border rounded px-3 py-2">
                            <option value="300">5 minutes</option>
                            <option value="600">10 minutes</option>
                            <option value="900">15 minutes</option>
                            <option value="1800">30 minutes</option>
                            <option value="3600" selected>1 hour</option>
                            <option value="7200">2 hours</option>
                            <option value="14400">4 hours</option>
                            <option value="21600">6 hours</option>
                        </select>
                    </div>

                    <!-- Recurrence Type -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Recurrence Type</label>
                        <select id="template-recurrence-type" class="w-full border rounded px-3 py-2">
                            <option value="one_time">One-Time (Manual)</option>
                            <option value="daily">Daily</option>
                            <option value="weekdays">Weekdays (Mon-Fri)</option>
                            <option value="weekends">Weekends (Sat-Sun)</option>
                            <option value="weekly">Weekly (Custom Days)</option>
                            <option value="monthly">Monthly (Specific Day)</option>
                        </select>
                    </div>

                    <!-- Recurrence Time -->
                    <div id="recurrence-time-div" style="display: none;">
                        <label class="block text-sm font-medium mb-1">Start Time</label>
                        <input type="time" id="template-recurrence-time"
                               class="w-full border rounded px-3 py-2"
                               value="09:00">
                    </div>

                    <!-- Weekly Days -->
                    <div id="weekly-days-div" style="display: none;">
                        <label class="block text-sm font-medium mb-2">Select Days</label>
                        <div class="grid grid-cols-2 gap-2">
                            <label class="flex items-center">
                                <input type="checkbox" value="0" class="mr-2 weekly-day"> Monday
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="1" class="mr-2 weekly-day"> Tuesday
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="2" class="mr-2 weekly-day"> Wednesday
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="3" class="mr-2 weekly-day"> Thursday
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="4" class="mr-2 weekly-day"> Friday
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="5" class="mr-2 weekly-day"> Saturday
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" value="6" class="mr-2 weekly-day"> Sunday
                            </label>
                        </div>
                    </div>

                    <!-- Monthly Day -->
                    <div id="monthly-day-div" style="display: none;">
                        <label class="block text-sm font-medium mb-1">Day of Month (1-31)</label>
                        <input type="number" id="template-day-of-month" min="1" max="31"
                               class="w-full border rounded px-3 py-2"
                               value="1">
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="template-description" rows="3"
                                  class="w-full border rounded px-3 py-2"
                                  placeholder="Optional description or notes"></textarea>
                    </div>

                    <!-- Buttons -->
                    <div class="flex space-x-2">
                        <button type="submit"
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-semibold">
                            Save Template
                        </button>
                        <button type="button" id="cancel-btn"
                                class="bg-gray-300 hover:bg-gray-400 px-6 py-2 rounded font-semibold"
                                style="display: none;">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Templates List -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4">Saved Templates</h2>

                <div id="templates-list" class="space-y-3">
                    {% if templates %}
                        {% for template in templates %}
                        <div class="border rounded p-4 template-item" data-template-id="{{ template.id }}">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold">{{ template.name }}</h3>
                                    <p class="text-sm text-gray-600">
                                        Duration: {{ (template.duration // 60) }} minutes
                                    </p>
                                    <p class="text-sm text-gray-600">
                                        Type: {{ template.recurrence_type or 'one_time' }}
                                        {% if template.recurrence_time %}
                                            at {{ template.recurrence_time }}
                                        {% endif %}
                                    </p>
                                    {% if template.description %}
                                    <p class="text-sm text-gray-500 mt-1">
                                        {{ template.description }}
                                    </p>
                                    {% endif %}
                                </div>
                                <div class="flex space-x-2">
                                    <button class="edit-template-btn text-blue-600 hover:text-blue-800"
                                            data-template-id="{{ template.id }}">
                                        Edit
                                    </button>
                                    <button class="delete-template-btn text-red-600 hover:text-red-800"
                                            data-template-id="{{ template.id }}">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-gray-500 text-center py-8">No templates saved</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Message Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg"
         style="display: none;">
        <span id="toast-message"></span>
    </div>

    <script>
        let isEditMode = false;

        // Show toast message
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }

        // Recurrence type change handler
        document.getElementById('template-recurrence-type').addEventListener('change', function() {
            const recurrenceTimeDiv = document.getElementById('recurrence-time-div');
            const weeklyDaysDiv = document.getElementById('weekly-days-div');
            const monthlyDayDiv = document.getElementById('monthly-day-div');

            const isRecurring = this.value !== 'one_time';
            recurrenceTimeDiv.style.display = isRecurring ? 'block' : 'none';

            weeklyDaysDiv.style.display = this.value === 'weekly' ? 'block' : 'none';
            monthlyDayDiv.style.display = this.value === 'monthly' ? 'block' : 'none';
        });

        // Form submit handler
        document.getElementById('template-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const templateId = document.getElementById('template-id').value;
            const name = document.getElementById('template-name').value;
            const duration = parseInt(document.getElementById('template-duration').value);
            const recurrenceType = document.getElementById('template-recurrence-type').value;
            const description = document.getElementById('template-description').value;

            const data = {
                name: name,
                duration: duration,
                recurrence_type: recurrenceType,
                description: description
            };

            // Add recurrence-specific fields
            if (recurrenceType !== 'one_time') {
                data.recurrence_time = document.getElementById('template-recurrence-time').value;

                if (recurrenceType === 'weekly') {
                    const selectedDays = [];
                    document.querySelectorAll('.weekly-day:checked').forEach(cb => {
                        selectedDays.push(cb.value);
                    });
                    data.recurrence_days = selectedDays.join(',');
                }

                if (recurrenceType === 'monthly') {
                    data.recurrence_day_of_month = parseInt(document.getElementById('template-day-of-month').value);
                }
            }

            // Determine if creating or updating
            const url = isEditMode ? `/api/templates/update/${templateId}` : '/api/templates/create';
            const method = isEditMode ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showToast(isEditMode ? 'Template updated' : 'Template created');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Error: ' + result.message, 5000);
                }
            })
            .catch(error => {
                showToast('Error: ' + error.message, 5000);
            });
        });

        // Edit template
        function editTemplate(templateId) {
            fetch(`/api/templates/get/${templateId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const template = data.template;

                        isEditMode = true;
                        document.getElementById('form-title').textContent = 'Edit Template';
                        document.getElementById('template-id').value = template.id;
                        document.getElementById('template-name').value = template.name;
                        document.getElementById('template-duration').value = template.duration;
                        document.getElementById('template-recurrence-type').value = template.recurrence_type || 'one_time';
                        document.getElementById('template-description').value = template.description || '';

                        if (template.recurrence_type && template.recurrence_type !== 'one_time') {
                            document.getElementById('template-recurrence-time').value = template.recurrence_time || '09:00';

                            if (template.recurrence_type === 'weekly' && template.recurrence_days) {
                                const days = template.recurrence_days.split(',');
                                document.querySelectorAll('.weekly-day').forEach(cb => {
                                    cb.checked = days.includes(cb.value);
                                });
                            }

                            if (template.recurrence_type === 'monthly' && template.recurrence_day_of_month) {
                                document.getElementById('template-day-of-month').value = template.recurrence_day_of_month;
                            }
                        }

                        document.getElementById('template-recurrence-type').dispatchEvent(new Event('change'));
                        document.getElementById('cancel-btn').style.display = 'block';

                        // Scroll to form
                        document.getElementById('template-form').scrollIntoView({ behavior: 'smooth' });
                    }
                });
        }

        // Cancel edit
        document.getElementById('cancel-btn').addEventListener('click', function() {
            isEditMode = false;
            document.getElementById('form-title').textContent = 'Create Template';
            document.getElementById('template-form').reset();
            document.getElementById('template-id').value = '';
            this.style.display = 'none';
            document.getElementById('template-recurrence-type').dispatchEvent(new Event('change'));
        });

        // Delete template
        function deleteTemplate(templateId) {
            if (confirm('Delete this template?')) {
                fetch(`/api/templates/delete/${templateId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showToast('Template deleted');
                        document.querySelector(`.template-item[data-template-id="${templateId}"]`).remove();
                    } else {
                        showToast('Error: ' + result.message, 5000);
                    }
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 5000);
                });
            }
        }

        // Attach event listeners
        document.querySelectorAll('.edit-template-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const templateId = this.getAttribute('data-template-id');
                editTemplate(templateId);
            });
        });

        document.querySelectorAll('.delete-template-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const templateId = this.getAttribute('data-template-id');
                deleteTemplate(templateId);
            });
        });
    </script>
</body>
</html>
