{% extends "base.html" %}

{% block title %}Church Recording - Control{% endblock %}

{% block page_subtitle %}Control{% endblock %}

{% block content %}
    <div class="container mx-auto p-6">
        <!-- Camera Not Configured Warning -->
        <div id="camera-not-configured" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-6">
            <strong>Camera not configured.</strong>
            <a href="/settings#camera-settings" class="underline">Go to Settings</a> to configure your PTZOptics camera.
        </div>

        <!-- Combined Recording Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Recording Status</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Audio Status -->
                <div class="border-r-0 md:border-r md:pr-6">
                    <h3 class="font-medium text-gray-700 mb-3">Audio</h3>
                    <div id="audio-status-indicator" class="flex items-center space-x-3 mb-3">
                        <div id="audio-status-light" class="w-4 h-4 rounded-full bg-gray-400"></div>
                        <span id="audio-status-text" class="text-lg font-medium text-gray-600">Idle</span>
                    </div>
                    <div id="audio-recording-info" class="hidden bg-blue-50 border border-blue-200 rounded p-3 text-sm">
                        <p><strong>Started:</strong> <span id="audio-start-time">--</span></p>
                        <p><strong>Job ID:</strong> <span id="audio-job-id">--</span></p>
                    </div>
                </div>

                <!-- Video Status -->
                <div class="md:pl-6">
                    <h3 class="font-medium text-gray-700 mb-3">Video</h3>
                    <div id="video-status-indicator" class="flex items-center space-x-3 mb-3">
                        <div id="video-status-light" class="w-4 h-4 rounded-full bg-gray-400"></div>
                        <span id="video-status-text" class="text-lg font-medium text-gray-600">Idle</span>
                    </div>
                    <div id="video-recording-info" class="hidden bg-red-50 border border-red-200 rounded p-3 text-sm">
                        <p><strong>Started:</strong> <span id="video-start-time">--</span></p>
                        <p><strong>File:</strong> <span id="video-current-file">--</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unified Recording Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Start Recording</h2>

            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Duration (minutes):</label>
                <input type="number" id="duration-input" value="60" min="1"
                    class="border border-gray-300 rounded px-3 py-2 w-32"
                    oninput="checkDurationWarning()">
            </div>

            <div id="duration-warning" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">
                <strong>Warning:</strong> Recording duration exceeds 4 hours.
                Long recordings require significant disk space (~345 MB/hour per audio channel).
            </div>

            <!-- Recording Type Buttons -->
            <div id="start-buttons" class="flex flex-wrap gap-3 mb-4">
                <button onclick="startRecording('audio')"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
                    </svg>
                    Audio Only
                </button>
                <button onclick="startRecording('video')"
                    class="bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                    </svg>
                    Video Only
                </button>
                <button onclick="startRecording('both')"
                    class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <circle cx="10" cy="10" r="6"/>
                    </svg>
                    Audio + Video
                </button>
            </div>

            <!-- Stop Button (shown when recording) -->
            <div id="stop-buttons" class="hidden flex flex-wrap gap-3 mb-4">
                <button onclick="stopRecording()"
                    class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-3 px-6 rounded">
                    Stop All Recording
                </button>
            </div>

            <!-- Storage Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 text-sm">
                <div class="p-3 bg-gray-50 rounded">
                    <strong>Audio Storage:</strong>
                    <span id="audio-storage-status">Checking...</span>
                </div>
                <div class="p-3 bg-gray-50 rounded">
                    <strong>Video Storage:</strong>
                    <span id="video-storage-status">Checking...</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- PTZ Preset Buttons -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">PTZ Presets</h2>
                <p class="text-sm text-gray-600 mb-4">Click a preset to move the camera to that position.</p>

                <div id="preset-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                    <!-- Preset buttons will be populated by JavaScript -->
                </div>

                <div id="preset-status" class="mt-4 text-sm text-gray-600 hidden">
                    <span id="preset-status-text"></span>
                </div>
            </div>

            <!-- Live Stream Info -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">View Live Stream</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Use these commands to view the live camera feed on another device.
                </p>

                <div id="stream-info-container">
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-1">FFplay Command:</label>
                        <div class="flex">
                            <input type="text" id="ffplay-command" readonly
                                class="flex-1 bg-gray-100 border rounded-l px-3 py-2 font-mono text-sm"
                                value="Not configured">
                            <button onclick="copyToClipboard('ffplay-command')"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r">
                                Copy
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-1">VLC / RTSP URL:</label>
                        <div class="flex">
                            <input type="text" id="rtsp-url" readonly
                                class="flex-1 bg-gray-100 border rounded-l px-3 py-2 font-mono text-sm"
                                value="Not configured">
                            <button onclick="copyToClipboard('rtsp-url')"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r">
                                Copy
                            </button>
                        </div>
                    </div>

                    <p class="text-xs text-gray-500">
                        Open VLC, go to Media â†’ Open Network Stream, and paste the RTSP URL.
                    </p>
                </div>
            </div>
        </div>

        <!-- Transcode Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">Video Processing Status</h2>

            <div id="transcode-idle" class="text-gray-600">
                <p>No video processing in progress.</p>
            </div>

            <div id="transcode-active" class="hidden">
                <div class="mb-2">
                    <span class="font-medium">Processing:</span>
                    <span id="transcode-file">--</span>
                </div>

                <div class="mb-2">
                    <span class="font-medium">Status:</span>
                    <span id="transcode-status-text" class="capitalize">--</span>
                </div>

                <div class="mb-4">
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div id="transcode-progress-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-1">
                        <span id="transcode-progress-text">0</span>% complete
                    </p>
                </div>

                <button onclick="cancelTranscode()"
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm">
                    Cancel Processing
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        // Preset configuration (will be loaded from server)
        let presetNames = {};
        const DEFAULT_PRESETS = {
            1: 'Preset 1',
            2: 'Preset 2',
            3: 'Preset 3',
            4: 'Preset 4',
            5: 'Preset 5',
            6: 'Preset 6',
            7: 'Preset 7',
            8: 'Preset 8',
            9: 'Preset 9',
            10: 'Preset 10'
        };

        // Initialize page
        window.addEventListener('DOMContentLoaded', () => {
            loadCameraConfig();
            loadStreamInfo();
            updateAllStatus();
        });

        // Poll status every 2 seconds
        setInterval(updateAllStatus, 2000);

        // Load camera configuration and preset names
        async function loadCameraConfig() {
            try {
                const response = await fetch('/api/camera/config');
                const config = await response.json();

                if (!config.camera_ip) {
                    document.getElementById('camera-not-configured').classList.remove('hidden');
                }

                presetNames = config.preset_names || {};
                renderPresetButtons();

            } catch (error) {
                console.error('Error loading camera config:', error);
            }
        }

        // Render preset buttons
        function renderPresetButtons() {
            const grid = document.getElementById('preset-grid');
            grid.innerHTML = '';

            // Show 10 preset buttons
            for (let i = 1; i <= 10; i++) {
                const name = presetNames[i] || DEFAULT_PRESETS[i];
                const btn = document.createElement('button');
                btn.className = 'bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded transition-colors';
                btn.textContent = name;
                btn.onclick = () => callPreset(i);
                grid.appendChild(btn);
            }
        }

        // Call camera preset
        async function callPreset(presetId) {
            const statusDiv = document.getElementById('preset-status');
            const statusText = document.getElementById('preset-status-text');

            statusDiv.classList.remove('hidden');
            statusText.textContent = `Calling preset ${presetId}...`;
            statusText.className = 'text-blue-600';

            try {
                const response = await fetch(`/api/camera/preset/${presetId}`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    statusText.textContent = `Preset ${presetId} called successfully`;
                    statusText.className = 'text-green-600';
                } else {
                    statusText.textContent = `Error: ${result.error}`;
                    statusText.className = 'text-red-600';
                }
            } catch (error) {
                statusText.textContent = `Error: ${error}`;
                statusText.className = 'text-red-600';
            }

            // Hide status after 3 seconds
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 3000);
        }

        // Load stream info
        async function loadStreamInfo() {
            try {
                const response = await fetch('/api/camera/stream');
                const info = await response.json();

                if (info.configured) {
                    document.getElementById('ffplay-command').value = info.ffplay_command;
                    document.getElementById('rtsp-url').value = info.rtsp_url;
                }
            } catch (error) {
                console.error('Error loading stream info:', error);
            }
        }

        // Update all recording status (audio + video)
        async function updateAllStatus() {
            try {
                // Fetch audio status
                const audioResponse = await fetch('/api/status');
                const audioStatus = await audioResponse.json();

                // Fetch video status
                const videoResponse = await fetch('/api/video/status');
                const videoData = await videoResponse.json();
                const videoRecording = videoData.recording;
                const transcode = videoData.transcode;

                // Update audio status
                const audioStatusLight = document.getElementById('audio-status-light');
                const audioStatusText = document.getElementById('audio-status-text');
                const audioRecordingInfo = document.getElementById('audio-recording-info');

                if (audioStatus.is_recording) {
                    audioStatusLight.className = 'w-4 h-4 rounded-full bg-green-500 animate-pulse';
                    audioStatusText.textContent = 'Recording';
                    audioStatusText.className = 'text-lg font-medium text-green-600';

                    document.getElementById('audio-start-time').textContent =
                        new Date(audioStatus.start_time).toLocaleString();
                    document.getElementById('audio-job-id').textContent = audioStatus.current_job || '--';

                    audioRecordingInfo.classList.remove('hidden');
                } else {
                    audioStatusLight.className = 'w-4 h-4 rounded-full bg-gray-400';
                    audioStatusText.textContent = 'Idle';
                    audioStatusText.className = 'text-lg font-medium text-gray-600';
                    audioRecordingInfo.classList.add('hidden');
                }

                // Update video status
                const videoStatusLight = document.getElementById('video-status-light');
                const videoStatusText = document.getElementById('video-status-text');
                const videoRecordingInfo = document.getElementById('video-recording-info');

                if (videoRecording.is_recording) {
                    videoStatusLight.className = 'w-4 h-4 rounded-full bg-red-500 animate-pulse';
                    videoStatusText.textContent = 'Recording';
                    videoStatusText.className = 'text-lg font-medium text-red-600';

                    if (videoRecording.start_time) {
                        document.getElementById('video-start-time').textContent =
                            new Date(videoRecording.start_time).toLocaleString();
                    }
                    if (videoRecording.current_file) {
                        const filename = videoRecording.current_file.split('/').pop();
                        document.getElementById('video-current-file').textContent = filename;
                    }

                    videoRecordingInfo.classList.remove('hidden');
                } else {
                    videoStatusLight.className = 'w-4 h-4 rounded-full bg-gray-400';
                    videoStatusText.textContent = 'Idle';
                    videoStatusText.className = 'text-lg font-medium text-gray-600';
                    videoRecordingInfo.classList.add('hidden');
                }

                // Toggle start/stop buttons based on any recording active
                const anyRecording = audioStatus.is_recording || videoRecording.is_recording;
                document.getElementById('start-buttons').classList.toggle('hidden', anyRecording);
                document.getElementById('stop-buttons').classList.toggle('hidden', !anyRecording);

                // Update transcode status
                const transcodeIdle = document.getElementById('transcode-idle');
                const transcodeActive = document.getElementById('transcode-active');

                if (transcode.is_processing) {
                    transcodeIdle.classList.add('hidden');
                    transcodeActive.classList.remove('hidden');

                    document.getElementById('transcode-file').textContent = transcode.current_file || '--';
                    document.getElementById('transcode-status-text').textContent = transcode.status || '--';
                    document.getElementById('transcode-progress-text').textContent = transcode.progress_percent || 0;
                    document.getElementById('transcode-progress-bar').style.width = `${transcode.progress_percent || 0}%`;
                } else {
                    transcodeIdle.classList.remove('hidden');
                    transcodeActive.classList.add('hidden');
                }

                // Update storage info
                updateStorageInfo();

            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Update storage info for both audio and video
        async function updateStorageInfo() {
            try {
                // Audio storage
                const audioResponse = await fetch('/api/system/disk');
                const audioData = await audioResponse.json();
                const audioStorageEl = document.getElementById('audio-storage-status');
                if (audioData.error) {
                    audioStorageEl.innerHTML = '<span class="text-red-600">Error</span>';
                } else {
                    const audioFreeGB = audioData.total_gb - audioData.used_gb;
                    const audioHours = Math.floor(audioFreeGB / 0.69); // ~690 MB/hr for both channels
                    audioStorageEl.innerHTML = `${audioFreeGB.toFixed(1)} GB free (~${audioHours} hrs)`;
                    audioStorageEl.className = audioHours < 2 ? 'text-red-600' : 'text-green-600';
                }

                // Video storage
                const videoResponse = await fetch('/api/video/storage');
                const videoInfo = await videoResponse.json();
                const videoStorageEl = document.getElementById('video-storage-status');

                if (videoInfo.mounted) {
                    videoStorageEl.innerHTML = `${videoInfo.free_gb} GB free (~${videoInfo.hours_remaining} hrs)`;
                    videoStorageEl.className = videoInfo.hours_remaining < 2 ? 'text-red-600' : 'text-green-600';
                } else {
                    videoStorageEl.innerHTML = `<span class="text-red-600">Not mounted</span>`;
                }
            } catch (error) {
                console.error('Error updating storage info:', error);
            }
        }

        // Duration warning check
        function checkDurationWarning() {
            const duration = parseInt(document.getElementById('duration-input').value) || 0;
            const warning = document.getElementById('duration-warning');
            if (duration > 240) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }

        // Start recording (type: 'audio', 'video', or 'both')
        async function startRecording(type) {
            const duration = parseInt(document.getElementById('duration-input').value) * 60;
            const allowOverride = duration > 14400;

            try {
                if (type === 'audio' || type === 'both') {
                    const captureVideo = type === 'both';
                    const response = await fetch('/api/record/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ duration, allow_override: allowOverride, capture_video: captureVideo })
                    });
                    const result = await response.json();
                    if (result.error) {
                        alert('Error starting audio: ' + result.error);
                        return;
                    }
                }

                if (type === 'video') {
                    const response = await fetch('/api/video/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ duration })
                    });
                    const result = await response.json();
                    if (result.error) {
                        alert('Error starting video: ' + result.error);
                        return;
                    }
                }

                updateAllStatus();
            } catch (error) {
                alert('Error starting recording: ' + error);
            }
        }

        // Stop all recording
        async function stopRecording() {
            if (!confirm('Stop all recording?')) return;

            try {
                const response = await fetch('/api/record/stop', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.error) {
                    alert('Error: ' + result.error);
                }
                updateAllStatus();
            } catch (error) {
                alert('Error stopping recording: ' + error);
            }
        }

        // Cancel transcoding
        async function cancelTranscode() {
            if (!confirm('Cancel video processing? The raw file will be preserved.')) return;

            try {
                const response = await fetch('/api/video/transcode/cancel', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.error) {
                    alert('Error: ' + result.error);
                }
                updateVideoStatus();
            } catch (error) {
                alert('Error: ' + error);
            }
        }

        // Copy to clipboard
        function copyToClipboard(elementId) {
            const input = document.getElementById(elementId);
            input.select();
            document.execCommand('copy');

            // Visual feedback
            const btn = input.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            btn.classList.add('bg-green-500');

            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('bg-green-500');
                btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            }, 1500);
        }
    </script>
{% endblock %}
