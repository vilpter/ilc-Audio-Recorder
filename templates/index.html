{% extends "base.html" %}

{% block title %}Audio Recorder - Dashboard{% endblock %}

{% block page_subtitle %}Dashboard{% endblock %}

{% block content %}
    <div class="container mx-auto p-6">
        <!-- Status Card -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Recording Status</h2>

            <div id="status-indicator" class="flex items-center space-x-3 mb-4">
                <div id="status-light" class="w-4 h-4 rounded-full bg-gray-400"></div>
                <span id="status-text" class="text-lg font-medium text-gray-600">Idle</span>
            </div>

            <div id="recording-info" class="hidden bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                <p class="text-sm text-gray-700">
                    <strong>Started:</strong> <span id="start-time">--</span>
                </p>
                <p class="text-sm text-gray-700">
                    <strong>Job ID:</strong> <span id="job-id">--</span>
                </p>
            </div>

            <!-- Manual Controls -->
            <div class="flex space-x-4">
                <button id="start-btn" onclick="startRecording()"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded">
                    Start Recording
                </button>
                <button id="stop-btn" onclick="stopRecording()"
                    class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded hidden">
                    Stop Recording
                </button>
            </div>
        </div>

        <!-- Quick Start Card -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Quick Record</h2>
            <div class="space-y-3">
                <div class="flex items-center space-x-4">
                    <label class="text-gray-700">Duration (minutes):</label>
                    <input type="number" id="duration-input" value="60" min="1"
                        class="border border-gray-300 rounded px-3 py-2 w-24"
                        oninput="checkDurationWarning()">
                </div>
                <div id="duration-warning" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                    <strong>Warning:</strong> Recording duration exceeds 4 hours.
                    Long recordings require significant disk space (~345 MB/hour per channel).
                </div>
                <button onclick="quickRecord()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded">
                    Start Quick Record
                </button>
            </div>
        </div>

        <!-- System Info -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">System Information</h2>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-600">Storage Location:</p>
                    <p class="font-mono text-gray-800">/home/pi/recordings</p>
                </div>
                <div>
                    <p class="text-gray-600">Audio Device:</p>
                    <p class="font-mono text-gray-800">hw:1 (USB Stereo)</p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        // Poll status every 2 seconds
        setInterval(updateStatus, 2000);
        updateStatus(); // Initial load

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                const statusLight = document.getElementById('status-light');
                const statusText = document.getElementById('status-text');
                const recordingInfo = document.getElementById('recording-info');
                const startBtn = document.getElementById('start-btn');
                const stopBtn = document.getElementById('stop-btn');

                if (status.is_recording) {
                    statusLight.className = 'w-4 h-4 rounded-full bg-red-500 animate-pulse';
                    statusText.textContent = 'Recording';
                    statusText.className = 'text-lg font-medium text-red-600';

                    document.getElementById('start-time').textContent =
                        new Date(status.start_time).toLocaleString();
                    document.getElementById('job-id').textContent = status.current_job;

                    recordingInfo.classList.remove('hidden');
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                } else {
                    statusLight.className = 'w-4 h-4 rounded-full bg-gray-400';
                    statusText.textContent = 'Idle';
                    statusText.className = 'text-lg font-medium text-gray-600';

                    recordingInfo.classList.add('hidden');
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        function checkDurationWarning() {
            const duration = parseInt(document.getElementById('duration-input').value) || 0;
            const warning = document.getElementById('duration-warning');
            if (duration > 240) {  // 4 hours = 240 minutes
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }

        async function startRecording() {
            const duration = parseInt(document.getElementById('duration-input').value) * 60;
            const allowOverride = duration > 14400;  // Auto-allow if > 4 hours (user saw warning)

            try {
                const response = await fetch('/api/record/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration, allow_override: allowOverride })
                });

                const result = await response.json();
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    updateStatus();
                }
            } catch (error) {
                alert('Error starting recording: ' + error);
            }
        }

        async function stopRecording() {
            if (!confirm('Stop the current recording?')) return;

            try {
                const response = await fetch('/api/record/stop', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    updateStatus();
                }
            } catch (error) {
                alert('Error stopping recording: ' + error);
            }
        }

        function quickRecord() {
            startRecording();
        }
    </script>
{% endblock %}
