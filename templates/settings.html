<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Recorder - Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto">
            <!-- Mobile header -->
            <div class="flex justify-between items-center">
                <h1 class="text-xl md:text-2xl font-bold">Audio Recorder</h1>

                <!-- Mobile menu button -->
                <button id="mobile-menu-btn" class="md:hidden p-2 rounded hover:bg-blue-700" onclick="toggleMobileMenu()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path id="menu-icon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>

                <!-- Desktop navigation -->
                <div class="hidden md:flex items-center space-x-4 lg:space-x-6">
                    <div class="space-x-3 lg:space-x-4">
                        <a href="/" class="hover:underline">Calendar</a>
                        <a href="/schedule" class="hover:underline">Schedule</a>
                        <a href="/recordings" class="hover:underline">Recordings</a>
                        <a href="/camera" class="hover:underline">Camera</a>
                        <a href="/settings" class="hover:underline font-semibold">Settings</a>
                    </div>
                    <div id="current-datetime" class="hidden lg:block text-sm font-mono bg-blue-700 px-3 py-1 rounded">
                        Loading...
                    </div>
                    <div id="disk-space" class="text-sm font-mono bg-blue-700 px-3 py-1 rounded cursor-pointer" title="Click for details">
                        <span id="disk-text">Loading...</span>
                    </div>
                    <div class="border-l border-blue-400 pl-3 lg:pl-4 flex items-center space-x-2 lg:space-x-3">
                        <span class="text-sm hidden lg:inline">{{ current_user.username }}</span>
                        <a href="/logout" class="bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded text-sm">Logout</a>
                    </div>
                </div>
            </div>

            <!-- Mobile menu -->
            <div id="mobile-menu" class="hidden md:hidden mt-4 pt-4 border-t border-blue-500">
                <div class="flex flex-col space-y-3">
                    <a href="/" class="hover:bg-blue-700 px-3 py-2 rounded">Calendar</a>
                    <a href="/schedule" class="hover:bg-blue-700 px-3 py-2 rounded">Schedule</a>
                    <a href="/recordings" class="hover:bg-blue-700 px-3 py-2 rounded">Recordings</a>
                    <a href="/camera" class="hover:bg-blue-700 px-3 py-2 rounded">Camera</a>
                    <a href="/settings" class="hover:bg-blue-700 px-3 py-2 rounded font-semibold">Settings</a>
                </div>
                <div class="mt-4 pt-4 border-t border-blue-500 flex flex-wrap gap-2">
                    <div id="disk-space-mobile" class="text-sm font-mono bg-blue-700 px-3 py-1 rounded">
                        <span id="disk-text-mobile">Loading...</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm">{{ current_user.username }}</span>
                        <a href="/logout" class="bg-blue-700 hover:bg-blue-800 px-3 py-1 rounded text-sm">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <script>
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
    </script>

    <div class="container mx-auto p-6">
        <!-- Recording Status & Quick Record -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Status Card -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Recording Status</h2>

                <div id="status-indicator" class="flex items-center space-x-3 mb-4">
                    <div id="status-light" class="w-4 h-4 rounded-full bg-gray-400"></div>
                    <span id="status-text" class="text-lg font-medium text-gray-600">Idle</span>
                </div>

                <div id="recording-info" class="hidden bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                    <p class="text-sm text-gray-700">
                        <strong>Started:</strong> <span id="rec-start-time">--</span>
                    </p>
                    <p class="text-sm text-gray-700">
                        <strong>Job ID:</strong> <span id="rec-job-id">--</span>
                    </p>
                </div>

                <!-- Manual Controls -->
                <div class="flex space-x-4">
                    <button id="start-btn" onclick="startRecording()"
                        class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded">
                        Start Recording
                    </button>
                    <button id="stop-btn" onclick="stopRecording()"
                        class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded hidden">
                        Stop Recording
                    </button>
                </div>
            </div>

            <!-- Quick Record Card -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Quick Record</h2>
                <div class="space-y-3">
                    <div class="flex items-center space-x-4">
                        <label class="text-gray-700">Duration (minutes):</label>
                        <input type="number" id="duration-input" value="60" min="1"
                            class="border border-gray-300 rounded px-3 py-2 w-24"
                            oninput="checkDurationWarning()">
                    </div>
                    <div id="duration-warning" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                        <strong>Warning:</strong> Recording duration exceeds 4 hours.
                        Long recordings require significant disk space (~345 MB/hour per channel).
                    </div>
                    <button onclick="quickRecord()"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded">
                        Start Quick Record
                    </button>
                </div>
            </div>
        </div>

        <!-- Audio Device Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Audio Device Configuration</h2>
            
            <!-- Auto-detect option -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="radio" name="device-mode" value="auto" id="mode-auto" 
                        checked class="mr-2" onchange="toggleDeviceMode()">
                    <span class="text-gray-700 font-medium">Automatically detect audio device (Recommended)</span>
                </label>
                <p class="text-sm text-gray-500 mt-1 ml-6">
                    System will automatically select USB audio device (Behringer UCA202)
                </p>
            </div>
            
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="radio" name="device-mode" value="manual" id="mode-manual" 
                        class="mr-2" onchange="toggleDeviceMode()">
                    <span class="text-gray-700 font-medium">Manually select device</span>
                </label>
            </div>
            
            <!-- Manual device selection -->
            <div id="manual-device-select" class="hidden ml-6 mb-4">
                <label class="block text-gray-700 mb-2">Select Audio Device</label>
                <select id="device-select" class="w-full md:w-1/2 border rounded px-3 py-2">
                    <option value="">Loading devices...</option>
                </select>
                
                <!-- Device info display -->
                <div id="device-info" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded hidden">
                    <!-- Shows selected device details -->
                </div>
            </div>
            
            <!-- Currently Active Device Display -->
            <div class="p-4 bg-green-50 border border-green-200 rounded mb-4">
                <h3 class="font-semibold text-green-900 mb-2">Currently Active Device</h3>
                <p class="text-sm text-green-800">
                    <strong>Mode:</strong> <span id="current-mode">Auto-detect</span><br>
                    <strong>Device:</strong> <span id="current-device">Loading...</span><br>
                    <strong>Status:</strong> 
                    <span id="device-status" class="text-green-600">● Checking...</span>
                </p>
            </div>
            
            <!-- Action buttons -->
            <div class="flex flex-wrap gap-2 sm:gap-3">
                <button onclick="testAudioDevice()"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold px-3 sm:px-4 py-2 rounded text-sm sm:text-base">
                    Test Device (3 sec)
                </button>

                <button onclick="saveAudioConfig()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-3 sm:px-4 py-2 rounded text-sm sm:text-base">
                    Save Configuration
                </button>

                <button onclick="refreshDevices()"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-semibold px-3 sm:px-4 py-2 rounded text-sm sm:text-base">
                    Refresh
                </button>
            </div>
        </div>

        <!-- Recording Filename Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Recording Filename Configuration</h2>
            
            <p class="text-sm text-gray-600 mb-4">
                Recording files use the format: <code class="bg-gray-100 px-2 py-1 rounded">YYYY_MMM_DD_HH:MM_[SUFFIX].wav</code>
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 mb-2">Left Channel Suffix</label>
                    <input type="text" id="left-suffix" value="L" maxlength="10"
                        class="w-full border border-gray-300 rounded px-3 py-2" 
                        placeholder="e.g., L, Left, Ch1">
                    <p class="text-xs text-gray-500 mt-1">Default: L</p>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Right Channel Suffix</label>
                    <input type="text" id="right-suffix" value="R" maxlength="10"
                        class="w-full border border-gray-300 rounded px-3 py-2"
                        placeholder="e.g., R, Right, Ch2">
                    <p class="text-xs text-gray-500 mt-1">Default: R</p>
                </div>
            </div>
            
            <!-- Preview -->
            <div class="p-4 bg-blue-50 border border-blue-200 rounded mb-4">
                <h3 class="font-semibold text-blue-900 mb-2">Filename Preview</h3>
                <p class="text-sm text-blue-800 font-mono">
                    <span id="filename-preview-left">2026_Jan_17_14:30_L.wav</span><br>
                    <span id="filename-preview-right">2026_Jan_17_14:30_R.wav</span>
                </p>
            </div>
            
            <button onclick="saveFilenameConfig()"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded">
                Save Filename Configuration
            </button>
        </div>

        <!-- Camera Configuration -->
        <div id="camera-settings" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Camera Configuration (PTZOptics)</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 mb-2">Camera IP Address</label>
                    <input type="text" id="camera-ip" placeholder="192.168.1.100"
                        class="w-full border border-gray-300 rounded px-3 py-2">
                    <p class="text-xs text-gray-500 mt-1">IP address of your PTZOptics camera</p>
                </div>

                <div>
                    <label class="block text-gray-700 mb-2">USB Storage Path</label>
                    <input type="text" id="usb-storage-path" placeholder="/mnt/usb_recorder"
                        class="w-full border border-gray-300 rounded px-3 py-2">
                    <p class="text-xs text-gray-500 mt-1">Mount point for video storage</p>
                </div>

                <div>
                    <label class="block text-gray-700 mb-2">Camera Username (optional)</label>
                    <input type="text" id="camera-username" placeholder="admin"
                        class="w-full border border-gray-300 rounded px-3 py-2">
                </div>

                <div>
                    <label class="block text-gray-700 mb-2">Camera Password (optional)</label>
                    <input type="password" id="camera-password" placeholder="********"
                        class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
            </div>

            <!-- Camera Connection Status -->
            <div id="camera-status" class="p-4 bg-gray-50 border rounded mb-4">
                <h3 class="font-semibold text-gray-700 mb-2">Connection Status</h3>
                <p class="text-sm">
                    <span id="camera-connection-status" class="text-gray-500">Not tested</span>
                </p>
            </div>

            <!-- Preset Naming -->
            <div class="mb-4">
                <h3 class="font-semibold text-gray-700 mb-3">Preset Names</h3>
                <p class="text-sm text-gray-600 mb-3">Customize the labels for PTZ preset buttons on the Camera page.</p>

                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2" id="preset-names-grid">
                    <!-- Preset name inputs will be generated by JavaScript -->
                </div>
            </div>

            <!-- Action buttons -->
            <div class="flex flex-wrap gap-2 sm:gap-3">
                <button onclick="testCameraConnection()"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold px-4 py-2 rounded">
                    Test Connection
                </button>

                <button onclick="saveCameraConfig()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded">
                    Save Camera Configuration
                </button>
            </div>
        </div>

        <!-- Backup & Restore -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Backup & Restore</h2>
            
            <!-- Export Section -->
            <div class="mb-6">
                <h3 class="font-semibold text-gray-700 mb-3">Export / Backup</h3>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                    <button onclick="exportSchedules()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm sm:text-base">
                        Export Schedules (.sched)
                    </button>
                    <button onclick="exportConfig()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm sm:text-base">
                        Export Config (.conf)
                    </button>
                </div>
            </div>

            <!-- Restore Schedules -->
            <div class="mb-6 border-t pt-4">
                <h3 class="font-semibold text-gray-700 mb-3">Restore Schedules</h3>
                <p class="text-sm text-gray-600 mb-3">
                    Upload a .sched file to restore schedules.
                    <span class="text-red-600 font-semibold block sm:inline">Warning: This will overwrite all current schedules!</span>
                </p>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3">
                    <input type="file" id="schedules-file" accept=".sched"
                        class="border rounded px-3 py-2 text-sm w-full sm:w-auto">
                    <button onclick="importSchedules()"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded text-sm sm:text-base whitespace-nowrap">
                        Restore Schedules
                    </button>
                </div>
            </div>

            <!-- Restore Configuration -->
            <div class="mb-6 border-t pt-4">
                <h3 class="font-semibold text-gray-700 mb-3">Restore System Configuration</h3>
                <p class="text-sm text-gray-600 mb-3">
                    Upload a .conf file to restore system configuration.
                    <span class="text-red-600 font-semibold block sm:inline">Warning: This will overwrite all current settings!</span>
                </p>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3">
                    <input type="file" id="config-file" accept=".conf"
                        class="border rounded px-3 py-2 text-sm w-full sm:w-auto">
                    <button onclick="importConfig()"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded text-sm sm:text-base whitespace-nowrap">
                        Restore Config
                    </button>
                </div>
            </div>

            <!-- Quick Revert -->
            <div class="border-t pt-4">
                <h3 class="font-semibold text-gray-700 mb-3">Quick Revert (Undo Last Restore)</h3>
                <p class="text-sm text-gray-600 mb-3">
                    Quickly restore to the state before your last import.
                </p>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                    <button id="revert-schedules-btn" onclick="revertSchedules()" disabled
                        class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed disabled:opacity-50 text-sm sm:text-base">
                        Revert Schedules
                    </button>
                    <button id="revert-config-btn" onclick="revertConfig()" disabled
                        class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed disabled:opacity-50 text-sm sm:text-base">
                        Revert Config
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    Revert buttons are enabled after importing backups
                </p>
            </div>
        </div>

        <!-- Account Settings -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Account Settings</h2>
            <p class="text-sm text-gray-600 mb-4">
                Logged in as: <strong>{{ current_user.username }}</strong>
            </p>
            <a href="/change-password"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded inline-block">
                Change Password
            </a>
        </div>

        <!-- Log Viewer -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">System Logs</h2>
                <div class="flex space-x-2">
                    <select id="log-type" onchange="loadLogs()" class="border rounded px-3 py-2">
                        <option value="app">Application Log</option>
                        <option value="error">Error Log</option>
                    </select>
                    <select id="log-lines" onchange="loadLogs()" class="border rounded px-3 py-2">
                        <option value="50">Last 50 lines</option>
                        <option value="100" selected>Last 100 lines</option>
                        <option value="200">Last 200 lines</option>
                        <option value="500">Last 500 lines</option>
                    </select>
                    <button onclick="loadLogs()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Refresh
                    </button>
                </div>
            </div>
            
            <div id="log-container" class="bg-gray-900 text-green-400 font-mono text-xs p-4 rounded overflow-auto" 
                 style="max-height: 500px;">
                <div class="text-gray-500">Loading logs...</div>
            </div>
            
            <div class="mt-2 text-sm text-gray-600">
                <span id="log-info">Showing last 100 lines</span>
            </div>
        </div>
    </div>

    <script>
        let availableDevices = [];

        // Update current date/time display
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('current-datetime').textContent =
                now.toLocaleString('en-US', options);
        }

        // Update immediately and then every second
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Disk space monitoring
        async function updateDiskSpace() {
            try {
                const response = await fetch('/api/system/disk');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('disk-text').textContent = 'Disk: Error';
                    const mobileText = document.getElementById('disk-text-mobile');
                    if (mobileText) mobileText.textContent = 'Disk: Error';
                    return;
                }

                const diskSpace = document.getElementById('disk-space');
                const diskText = document.getElementById('disk-text');
                const diskSpaceMobile = document.getElementById('disk-space-mobile');
                const diskTextMobile = document.getElementById('disk-text-mobile');

                // Format display: "X.X GB / Y.Y GB"
                const displayText = `${data.used_gb} / ${data.total_gb} GB`;
                diskText.textContent = displayText;
                if (diskTextMobile) diskTextMobile.textContent = displayText;

                // Set title with more details
                diskSpace.title = `Used: ${data.used_gb} GB of ${data.total_gb} GB (${data.percent_used}%)\n` +
                    `Free: ${data.free_gb} GB\n` +
                    `Recording time remaining: ~${data.hours_remaining} hours`;

                // Determine class based on warning state
                let className = 'text-sm font-mono bg-blue-700 px-3 py-1 rounded cursor-pointer';
                if (data.low_space_warning || data.scheduled_warning) {
                    className = 'text-sm font-mono bg-red-600 px-3 py-1 rounded cursor-pointer animate-pulse';
                } else if (data.hours_remaining < 24) {
                    className = 'text-sm font-mono bg-yellow-600 px-3 py-1 rounded cursor-pointer';
                }

                diskSpace.className = className;
                if (diskSpaceMobile) diskSpaceMobile.className = className;

            } catch (error) {
                console.error('Error fetching disk space:', error);
                document.getElementById('disk-text').textContent = 'Disk: --';
                const mobileText = document.getElementById('disk-text-mobile');
                if (mobileText) mobileText.textContent = 'Disk: --';
            }
        }

        // Update disk space immediately and every 30 seconds
        updateDiskSpace();
        setInterval(updateDiskSpace, 30000);

        // Load on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadCurrentConfig();
            loadDevices();
            loadLogs();
            updateRecordingStatus();
            loadCameraConfig();
        });

        // Poll recording status every 2 seconds
        setInterval(updateRecordingStatus, 2000);

        async function updateRecordingStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                const statusLight = document.getElementById('status-light');
                const statusText = document.getElementById('status-text');
                const recordingInfo = document.getElementById('recording-info');
                const startBtn = document.getElementById('start-btn');
                const stopBtn = document.getElementById('stop-btn');

                if (status.is_recording) {
                    statusLight.className = 'w-4 h-4 rounded-full bg-red-500 animate-pulse';
                    statusText.textContent = 'Recording';
                    statusText.className = 'text-lg font-medium text-red-600';

                    document.getElementById('rec-start-time').textContent =
                        new Date(status.start_time).toLocaleString();
                    document.getElementById('rec-job-id').textContent = status.current_job;

                    recordingInfo.classList.remove('hidden');
                    startBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                } else {
                    statusLight.className = 'w-4 h-4 rounded-full bg-gray-400';
                    statusText.textContent = 'Idle';
                    statusText.className = 'text-lg font-medium text-gray-600';

                    recordingInfo.classList.add('hidden');
                    startBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        function checkDurationWarning() {
            const duration = parseInt(document.getElementById('duration-input').value) || 0;
            const warning = document.getElementById('duration-warning');
            if (duration > 240) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }

        async function startRecording() {
            const duration = parseInt(document.getElementById('duration-input').value) * 60;
            const allowOverride = duration > 14400;

            try {
                const response = await fetch('/api/record/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration, allow_override: allowOverride })
                });

                const result = await response.json();
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    updateRecordingStatus();
                }
            } catch (error) {
                alert('Error starting recording: ' + error);
            }
        }

        async function stopRecording() {
            if (!confirm('Stop the current recording?')) return;

            try {
                const response = await fetch('/api/record/stop', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    updateRecordingStatus();
                }
            } catch (error) {
                alert('Error stopping recording: ' + error);
            }
        }

        function quickRecord() {
            startRecording();
        }

        async function loadCurrentConfig() {
            try {
                const response = await fetch('/api/audio/config');
                const data = await response.json();
                
                // Update display
                const mode = data.current_device === 'auto' ? 'Auto-detect' : 'Manual';
                document.getElementById('current-mode').textContent = mode;
                document.getElementById('current-device').textContent = data.actual_device;
                
                if (data.device_info) {
                    document.getElementById('current-device').textContent = 
                        `${data.device_info.name} (${data.actual_device})`;
                    document.getElementById('device-status').innerHTML = 
                        '<span class="text-green-600">● Connected</span>';
                } else {
                    document.getElementById('device-status').innerHTML = 
                        '<span class="text-red-600">● Not Found</span>';
                }
                
                // Set radio buttons
                if (data.current_device === 'auto') {
                    document.getElementById('mode-auto').checked = true;
                } else {
                    document.getElementById('mode-manual').checked = true;
                    toggleDeviceMode();
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        async function loadDevices() {
            try {
                const response = await fetch('/api/audio/devices');
                const data = await response.json();
                availableDevices = data.devices;
                
                const select = document.getElementById('device-select');
                select.innerHTML = '';
                
                if (data.devices.length === 0) {
                    select.innerHTML = '<option value="">No devices found</option>';
                    return;
                }
                
                data.devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.alsa_id;
                    option.textContent = `${device.name} (${device.alsa_id})`;
                    if (device.is_recommended) {
                        option.textContent += ' ⭐ Recommended';
                    }
                    if (device.alsa_id === data.actual_device) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Update device info when selection changes
                select.addEventListener('change', updateDeviceInfo);
                updateDeviceInfo();
                
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        function toggleDeviceMode() {
            const manualMode = document.getElementById('mode-manual').checked;
            const manualSelect = document.getElementById('manual-device-select');
            manualSelect.classList.toggle('hidden', !manualMode);
        }

        function updateDeviceInfo() {
            const select = document.getElementById('device-select');
            const selectedId = select.value;
            const device = availableDevices.find(d => d.alsa_id === selectedId);
            const infoDiv = document.getElementById('device-info');
            
            if (device) {
                infoDiv.classList.remove('hidden');
                infoDiv.innerHTML = `
                    <p class="text-sm"><strong>Device:</strong> ${device.name}</p>
                    <p class="text-sm"><strong>Description:</strong> ${device.description}</p>
                    <p class="text-sm"><strong>ALSA ID:</strong> ${device.alsa_id}</p>
                    <p class="text-sm"><strong>Card:</strong> ${device.card}, <strong>Device:</strong> ${device.device}</p>
                    ${device.is_recommended ? '<p class="text-sm text-blue-600">⭐ Recommended for this system</p>' : ''}
                `;
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        async function testAudioDevice() {
            const autoMode = document.getElementById('mode-auto').checked;
            const device = autoMode ? 'auto' : document.getElementById('device-select').value;
            
            if (!autoMode && !device) {
                alert('Please select a device first');
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing... (3 sec)';
            
            try {
                const response = await fetch('/api/audio/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device, duration: 3 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`✓ Audio test successful!\n\nDevice: ${result.device}\nFile size: ${result.file_size_mb} MB`);
                } else {
                    alert(`✗ Audio test failed:\n\n${result.error}`);
                }
            } catch (error) {
                alert('Error testing device: ' + error);
            } finally {
                button.disabled = false;
                button.textContent = 'Test Selected Device (3 sec)';
            }
        }

        async function saveAudioConfig() {
            const autoMode = document.getElementById('mode-auto').checked;
            const device = autoMode ? 'auto' : document.getElementById('device-select').value;
            
            if (!autoMode && !device) {
                alert('Please select a device first');
                return;
            }
            
            try {
                const response = await fetch('/api/audio/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Configuration saved successfully!\n\nChanges will take effect for new recordings.');
                    loadCurrentConfig();
                } else {
                    alert('✗ Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving configuration: ' + error);
            }
        }

        function refreshDevices() {
            loadDevices();
            loadCurrentConfig();
        }

        async function loadLogs() {
            const logType = document.getElementById('log-type').value;
            const lines = document.getElementById('log-lines').value;
            
            try {
                const response = await fetch(`/api/logs?type=${logType}&lines=${lines}`);
                const data = await response.json();
                
                const container = document.getElementById('log-container');
                
                if (data.logs && data.logs.length > 0) {
                    container.innerHTML = data.logs.map(line => 
                        `<div>${escapeHtml(line)}</div>`
                    ).join('');
                    
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                    
                    document.getElementById('log-info').textContent = 
                        `Showing ${data.showing_lines} of ${data.total_lines} total lines`;
                } else {
                    container.innerHTML = '<div class="text-gray-500">No logs available</div>';
                    document.getElementById('log-info').textContent = 'No logs found';
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('log-container').innerHTML = 
                    '<div class="text-red-500">Error loading logs</div>';
            }
        }

        // Filename Configuration Functions
        async function loadFilenameConfig() {
            try {
                const response = await fetch('/api/config/filename');
                const data = await response.json();
                
                document.getElementById('left-suffix').value = data.left_suffix || 'L';
                document.getElementById('right-suffix').value = data.right_suffix || 'R';
                
                updateFilenamePreview();
            } catch (error) {
                console.error('Error loading filename config:', error);
            }
        }

        function updateFilenamePreview() {
            const now = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const year = now.getFullYear();
            const month = months[now.getMonth()];
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const leftSuffix = document.getElementById('left-suffix').value || 'L';
            const rightSuffix = document.getElementById('right-suffix').value || 'R';
            
            document.getElementById('filename-preview-left').textContent = 
                `${year}_${month}_${day}_${hours}:${minutes}_${leftSuffix}.wav`;
            document.getElementById('filename-preview-right').textContent = 
                `${year}_${month}_${day}_${hours}:${minutes}_${rightSuffix}.wav`;
        }

        // Update preview on input
        document.addEventListener('DOMContentLoaded', () => {
            loadFilenameConfig();
            document.getElementById('left-suffix').addEventListener('input', updateFilenamePreview);
            document.getElementById('right-suffix').addEventListener('input', updateFilenamePreview);
        });

        async function saveFilenameConfig() {
            const leftSuffix = document.getElementById('left-suffix').value.trim();
            const rightSuffix = document.getElementById('right-suffix').value.trim();
            
            if (!leftSuffix || !rightSuffix) {
                alert('Both channel suffixes are required');
                return;
            }
            
            if (leftSuffix === rightSuffix) {
                if (!confirm('Warning: Left and right channel suffixes are the same. This may cause confusion. Continue anyway?')) {
                    return;
                }
            }
            
            try {
                const response = await fetch('/api/config/filename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        left_suffix: leftSuffix,
                        right_suffix: rightSuffix
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Filename configuration saved successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving filename configuration: ' + error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Backup/Restore Functions
        async function checkRevertAvailable() {
            try {
                const response = await fetch('/api/revert/available');
                const data = await response.json();
                
                const schedulesBtn = document.getElementById('revert-schedules-btn');
                const configBtn = document.getElementById('revert-config-btn');
                
                if (data.schedules_available) {
                    schedulesBtn.disabled = false;
                    schedulesBtn.className = 'bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded cursor-pointer';
                }
                
                if (data.config_available) {
                    configBtn.disabled = false;
                    configBtn.className = 'bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded cursor-pointer';
                }
            } catch (error) {
                console.error('Error checking revert availability:', error);
            }
        }

        // Check revert availability on page load
        checkRevertAvailable();

        function exportSchedules() {
            window.location.href = '/api/export/schedules';
        }

        function exportConfig() {
            window.location.href = '/api/export/config';
        }

        async function importSchedules() {
            const fileInput = document.getElementById('schedules-file');
            if (!fileInput.files.length) {
                alert('Please select a .sched file first');
                return;
            }
            
            if (!confirm('WARNING: This will overwrite all current schedules and templates!\n\nCurrent data will be backed up automatically.\n\nAre you sure you want to continue?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch('/api/import/schedules', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Schedules imported successfully!\n\nPrevious schedules backed up. Use Revert button if needed.');
                    fileInput.value = '';
                    checkRevertAvailable();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error importing schedules: ' + error);
            }
        }

        async function importConfig() {
            const fileInput = document.getElementById('config-file');
            if (!fileInput.files.length) {
                alert('Please select a .conf file first');
                return;
            }
            
            if (!confirm('WARNING: This will overwrite all current configuration!\n\nCurrent configuration will be backed up automatically.\n\nAre you sure you want to continue?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch('/api/import/config', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Configuration imported successfully!\n\nPrevious configuration backed up. Use Revert button if needed.');
                    fileInput.value = '';
                    checkRevertAvailable();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error importing configuration: ' + error);
            }
        }

        async function revertSchedules() {
            if (!confirm('Revert to previous schedules?\n\nThis will restore schedules from before your last import.\n\nCurrent schedules will be lost!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/revert/schedules', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Reverted to previous schedules!');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error reverting: ' + error);
            }
        }

        async function revertConfig() {
            if (!confirm('Revert to previous configuration?\n\nThis will restore configuration from before your last import.\n\nCurrent configuration will be lost!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/revert/config', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Reverted to previous configuration!');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error reverting: ' + error);
            }
        }

        // Auto-refresh logs every 5 seconds
        setInterval(loadLogs, 5000);

        // ============================================================================
        // Camera Configuration Functions
        // ============================================================================

        let cameraPresetNames = {};

        async function loadCameraConfig() {
            try {
                const response = await fetch('/api/camera/config');
                const config = await response.json();

                document.getElementById('camera-ip').value = config.camera_ip || '';
                document.getElementById('camera-username').value = config.camera_username || '';
                document.getElementById('usb-storage-path').value = config.usb_storage_path || '/mnt/usb_recorder';

                // Don't show actual password, just indicate if one is set
                if (config.camera_password && config.camera_password !== '') {
                    document.getElementById('camera-password').placeholder = '(password set)';
                }

                cameraPresetNames = config.preset_names || {};
                renderPresetNameInputs();

            } catch (error) {
                console.error('Error loading camera config:', error);
            }
        }

        function renderPresetNameInputs() {
            const grid = document.getElementById('preset-names-grid');
            grid.innerHTML = '';

            for (let i = 1; i <= 10; i++) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs text-gray-600 mb-1">Preset ${i}</label>
                    <input type="text" id="preset-name-${i}"
                        value="${cameraPresetNames[i] || ''}"
                        placeholder="Preset ${i}"
                        class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                `;
                grid.appendChild(div);
            }
        }

        async function testCameraConnection() {
            const statusSpan = document.getElementById('camera-connection-status');
            statusSpan.textContent = 'Testing...';
            statusSpan.className = 'text-blue-600';

            // First save the config temporarily
            await saveCameraConfig(true);

            try {
                const response = await fetch('/api/camera/test', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    statusSpan.textContent = 'Connected successfully';
                    statusSpan.className = 'text-green-600';
                } else {
                    statusSpan.textContent = 'Connection failed: ' + result.error;
                    statusSpan.className = 'text-red-600';
                }
            } catch (error) {
                statusSpan.textContent = 'Error: ' + error;
                statusSpan.className = 'text-red-600';
            }
        }

        async function saveCameraConfig(silent = false) {
            const cameraIp = document.getElementById('camera-ip').value.trim();
            const cameraUsername = document.getElementById('camera-username').value.trim();
            const cameraPassword = document.getElementById('camera-password').value;
            const usbStoragePath = document.getElementById('usb-storage-path').value.trim();

            // Collect preset names
            const presetNames = {};
            for (let i = 1; i <= 10; i++) {
                const input = document.getElementById(`preset-name-${i}`);
                if (input && input.value.trim()) {
                    presetNames[i] = input.value.trim();
                }
            }

            const configData = {
                camera_ip: cameraIp,
                camera_username: cameraUsername,
                usb_storage_path: usbStoragePath,
                preset_names: presetNames
            };

            // Only include password if it was changed
            if (cameraPassword && cameraPassword !== '') {
                configData.camera_password = cameraPassword;
            }

            try {
                const response = await fetch('/api/camera/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });

                const result = await response.json();

                if (result.success) {
                    if (!silent) {
                        alert('Camera configuration saved successfully!');
                    }
                    // Clear password field after save
                    document.getElementById('camera-password').value = '';
                    document.getElementById('camera-password').placeholder = cameraPassword ? '(password set)' : '********';
                } else {
                    if (!silent) {
                        alert('Error: ' + result.error);
                    }
                }

                return result.success;
            } catch (error) {
                if (!silent) {
                    alert('Error saving camera configuration: ' + error);
                }
                return false;
            }
        }
    </script>
</body>
</html>
