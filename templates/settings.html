{% extends "base.html" %}

{% block title %}Church Recording - Settings{% endblock %}

{% block page_subtitle %}Settings{% endblock %}

{% block content %}
    <div class="container mx-auto p-6">
        <!-- Audio Device Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Audio Device Configuration</h2>
            
            <!-- Auto-detect option -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="radio" name="device-mode" value="auto" id="mode-auto" 
                        checked class="mr-2" onchange="toggleDeviceMode()">
                    <span class="text-gray-700 font-medium">Automatically detect audio device (Recommended)</span>
                </label>
                <p class="text-sm text-gray-500 mt-1 ml-6">
                    System will automatically select USB audio device (Behringer UCA202)
                </p>
            </div>
            
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="radio" name="device-mode" value="manual" id="mode-manual" 
                        class="mr-2" onchange="toggleDeviceMode()">
                    <span class="text-gray-700 font-medium">Manually select device</span>
                </label>
            </div>
            
            <!-- Manual device selection -->
            <div id="manual-device-select" class="hidden ml-6 mb-4">
                <label class="block text-gray-700 mb-2">Select Audio Device</label>
                <select id="device-select" class="w-full md:w-1/2 border rounded px-3 py-2">
                    <option value="">Loading devices...</option>
                </select>
                
                <!-- Device info display -->
                <div id="device-info" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded hidden">
                    <!-- Shows selected device details -->
                </div>
            </div>
            
            <!-- Currently Active Device Display -->
            <div class="p-4 bg-green-50 border border-green-200 rounded mb-4">
                <h3 class="font-semibold text-green-900 mb-2">Currently Active Device</h3>
                <p class="text-sm text-green-800">
                    <strong>Mode:</strong> <span id="current-mode">Auto-detect</span><br>
                    <strong>Device:</strong> <span id="current-device">Loading...</span><br>
                    <strong>Status:</strong> 
                    <span id="device-status" class="text-green-600">● Checking...</span>
                </p>
            </div>
            
            <!-- Action buttons -->
            <div class="flex flex-wrap gap-2 sm:gap-3">
                <button onclick="testAudioDevice()"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold px-3 sm:px-4 py-2 rounded text-sm sm:text-base">
                    Test Device (3 sec)
                </button>

                <button onclick="saveAudioConfig()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-3 sm:px-4 py-2 rounded text-sm sm:text-base">
                    Save Configuration
                </button>

                <button onclick="refreshDevices()"
                    class="bg-gray-500 hover:bg-gray-600 text-white font-semibold px-3 sm:px-4 py-2 rounded text-sm sm:text-base">
                    Refresh
                </button>
            </div>
        </div>

        <!-- File Naming and Location -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">File Naming and Location</h2>

            <!-- Storage Path Configuration -->
            <div class="mb-6">
                <h3 class="font-semibold text-gray-700 mb-3">Storage Location</h3>
                <p class="text-sm text-gray-600 mb-3">
                    Configure the base path where all recordings (audio and video) will be stored.
                    Audio files are saved directly in this path. Video files are saved in <code class="bg-gray-100 px-1">raw/</code> and <code class="bg-gray-100 px-1">processed/</code> subdirectories.
                </p>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Storage Path</label>
                    <div class="flex gap-2">
                        <input type="text" id="storage-path" placeholder="/mnt/usb_recorder"
                            class="flex-1 border border-gray-300 rounded px-3 py-2">
                        <button onclick="openDirectoryBrowser()"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded whitespace-nowrap">
                            Browse...
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Default: /mnt/usb_recorder</p>
                </div>

                <!-- Storage Status -->
                <div id="storage-status" class="p-4 bg-gray-50 border rounded mb-4">
                    <h4 class="font-semibold text-gray-700 mb-2">Storage Status</h4>
                    <p class="text-sm">
                        <span id="storage-status-text" class="text-gray-500">Checking...</span>
                    </p>
                </div>

                <button onclick="saveStorageConfig()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded">
                    Save Storage Location
                </button>
            </div>

            <hr class="my-6 border-gray-200">

            <!-- Audio Filename Suffixes -->
            <h3 class="font-semibold text-gray-700 mb-3">Audio Filename Suffixes</h3>
            <p class="text-sm text-gray-600 mb-4">
                Recording files use the format: <code class="bg-gray-100 px-2 py-1 rounded">YYYY_MMM_DD_HH:MM_[SUFFIX].wav</code>
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 mb-2">Left Channel Suffix</label>
                    <input type="text" id="left-suffix" value="L" maxlength="10"
                        class="w-full border border-gray-300 rounded px-3 py-2"
                        placeholder="e.g., L, Left, Ch1">
                    <p class="text-xs text-gray-500 mt-1">Default: L</p>
                </div>

                <div>
                    <label class="block text-gray-700 mb-2">Right Channel Suffix</label>
                    <input type="text" id="right-suffix" value="R" maxlength="10"
                        class="w-full border border-gray-300 rounded px-3 py-2"
                        placeholder="e.g., R, Right, Ch2">
                    <p class="text-xs text-gray-500 mt-1">Default: R</p>
                </div>
            </div>

            <!-- Preview -->
            <div class="p-4 bg-blue-50 border border-blue-200 rounded mb-4">
                <h3 class="font-semibold text-blue-900 mb-2">Filename Preview</h3>
                <p class="text-sm text-blue-800 font-mono">
                    <span id="filename-preview-left">2026_Jan_17_14:30_L.wav</span><br>
                    <span id="filename-preview-right">2026_Jan_17_14:30_R.wav</span>
                </p>
            </div>

            <button onclick="saveFilenameConfig()"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded">
                Save Filename Configuration
            </button>
        </div>

        <!-- Camera Configuration -->
        <div id="camera-settings" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Camera Configuration (PTZOptics)</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-gray-700 mb-2">Camera IP Address</label>
                    <input type="text" id="camera-ip" placeholder="192.168.1.100"
                        class="w-full border border-gray-300 rounded px-3 py-2">
                    <p class="text-xs text-gray-500 mt-1">IP address of your PTZOptics camera</p>
                </div>

                <div>
                    <label class="block text-gray-700 mb-2">Camera Username (optional)</label>
                    <input type="text" id="camera-username" placeholder="admin"
                        class="w-full border border-gray-300 rounded px-3 py-2">
                </div>

                <div>
                    <label class="block text-gray-700 mb-2">Camera Password (optional)</label>
                    <input type="password" id="camera-password" placeholder="********"
                        class="w-full border border-gray-300 rounded px-3 py-2">
                </div>
            </div>

            <!-- Camera Connection Status -->
            <div id="camera-status" class="p-4 bg-gray-50 border rounded mb-4">
                <h3 class="font-semibold text-gray-700 mb-2">Connection Status</h3>
                <p class="text-sm">
                    <span id="camera-connection-status" class="text-gray-500">Not tested</span>
                </p>
            </div>

            <!-- Preset Naming -->
            <div class="mb-4">
                <h3 class="font-semibold text-gray-700 mb-3">Preset Names</h3>
                <p class="text-sm text-gray-600 mb-3">Customize the labels for PTZ preset buttons on the Camera page.</p>

                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2" id="preset-names-grid">
                    <!-- Preset name inputs will be generated by JavaScript -->
                </div>
            </div>

            <!-- Action buttons -->
            <div class="flex flex-wrap gap-2 sm:gap-3">
                <button onclick="testCameraConnection()"
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold px-4 py-2 rounded">
                    Test Connection
                </button>

                <button onclick="saveCameraConfig()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded">
                    Save Camera Configuration
                </button>
            </div>
        </div>

        <!-- Backup & Restore -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Backup & Restore</h2>
            
            <!-- Export Section -->
            <div class="mb-6">
                <h3 class="font-semibold text-gray-700 mb-3">Export / Backup</h3>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                    <button onclick="exportSchedules()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm sm:text-base">
                        Export Schedules (.sched)
                    </button>
                    <button onclick="exportConfig()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm sm:text-base">
                        Export Config (.conf)
                    </button>
                </div>
            </div>

            <!-- Restore Schedules -->
            <div class="mb-6 border-t pt-4">
                <h3 class="font-semibold text-gray-700 mb-3">Restore Schedules</h3>
                <p class="text-sm text-gray-600 mb-3">
                    Upload a .sched file to restore schedules.
                    <span class="text-red-600 font-semibold block sm:inline">Warning: This will overwrite all current schedules!</span>
                </p>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3">
                    <input type="file" id="schedules-file" accept=".sched"
                        class="border rounded px-3 py-2 text-sm w-full sm:w-auto">
                    <button onclick="importSchedules()"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded text-sm sm:text-base whitespace-nowrap">
                        Restore Schedules
                    </button>
                </div>
            </div>

            <!-- Restore Configuration -->
            <div class="mb-6 border-t pt-4">
                <h3 class="font-semibold text-gray-700 mb-3">Restore System Configuration</h3>
                <p class="text-sm text-gray-600 mb-3">
                    Upload a .conf file to restore system configuration.
                    <span class="text-red-600 font-semibold block sm:inline">Warning: This will overwrite all current settings!</span>
                </p>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3">
                    <input type="file" id="config-file" accept=".conf"
                        class="border rounded px-3 py-2 text-sm w-full sm:w-auto">
                    <button onclick="importConfig()"
                        class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded text-sm sm:text-base whitespace-nowrap">
                        Restore Config
                    </button>
                </div>
            </div>

            <!-- Quick Revert -->
            <div class="border-t pt-4">
                <h3 class="font-semibold text-gray-700 mb-3">Quick Revert (Undo Last Restore)</h3>
                <p class="text-sm text-gray-600 mb-3">
                    Quickly restore to the state before your last import.
                </p>
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                    <button id="revert-schedules-btn" onclick="revertSchedules()" disabled
                        class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed disabled:opacity-50 text-sm sm:text-base">
                        Revert Schedules
                    </button>
                    <button id="revert-config-btn" onclick="revertConfig()" disabled
                        class="bg-gray-400 text-white px-4 py-2 rounded cursor-not-allowed disabled:opacity-50 text-sm sm:text-base">
                        Revert Config
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    Revert buttons are enabled after importing backups
                </p>
            </div>

            <!-- Database Clean-Up -->
            <div class="border-t pt-4">
                <h3 class="font-semibold text-gray-700 mb-3">Database Clean-Up</h3>
                <p class="text-sm text-gray-600 mb-3">
                    Remove old completed, failed, or cancelled recording entries to free up database space.
                    Recurring recording patterns are preserved.
                </p>
                <button onclick="openCleanupModal()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded text-sm sm:text-base">
                    Clean Up Database
                </button>
            </div>
        </div>

        <!-- Account Settings -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Account Settings</h2>
            <p class="text-sm text-gray-600 mb-4">
                Logged in as: <strong>{{ current_user.username }}</strong>
            </p>
            <a href="/change-password"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded inline-block">
                Change Password
            </a>
        </div>

        <!-- Log Viewer -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                <h2 class="text-xl font-semibold">System Logs</h2>
                <div class="flex flex-wrap gap-2">
                    <select id="log-type" onchange="loadLogs(); updateLogPath()" class="border rounded px-3 py-2">
                        <option value="app">Application Log</option>
                        <option value="recorder">Recorder Log</option>
                        <option value="scheduler">Scheduler Log</option>
                        <option value="ffmpeg">FFmpeg Log</option>
                        <option value="error">Error Log</option>
                    </select>
                    <select id="log-lines" onchange="loadLogs()" class="border rounded px-3 py-2">
                        <option value="50">Last 50 lines</option>
                        <option value="100" selected>Last 100 lines</option>
                        <option value="200">Last 200 lines</option>
                        <option value="500">Last 500 lines</option>
                    </select>
                    <button onclick="loadLogs()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Log file path display -->
            <div id="log-path-display" class="mb-3 p-2 bg-gray-100 rounded text-xs font-mono text-gray-600">
                <span class="font-semibold">File:</span> <span id="current-log-path">Loading...</span>
            </div>

            <div id="log-container" class="bg-gray-900 text-green-400 font-mono text-xs p-4 rounded overflow-auto"
                 style="max-height: 500px;">
                <div class="text-gray-500">Loading logs...</div>
            </div>

            <div class="mt-2 text-sm text-gray-600 flex flex-col sm:flex-row sm:justify-between gap-1">
                <span id="log-info">Showing last 100 lines</span>
                <span class="text-gray-400 text-xs">Timestamps are in local time</span>
            </div>
        </div>
    </div>

    <!-- Directory Browser Modal -->
    <div id="directory-browser-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b">
                <h2 class="text-xl font-semibold text-gray-800">Browse Directories</h2>
                <button onclick="closeDirectoryBrowser()" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">
                    &times;
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Current Path Display -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Current Path</label>
                    <input type="text" id="browser-current-path" readonly
                        class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50 text-gray-700">
                </div>

                <!-- Breadcrumb Navigation -->
                <div id="browser-breadcrumbs" class="mb-4 flex flex-wrap items-center gap-1 text-sm">
                    <!-- Breadcrumbs will be inserted here by JavaScript -->
                </div>

                <!-- Directory Listing -->
                <div class="mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Directories</h3>
                    <div id="directory-list" class="border border-gray-300 rounded overflow-y-auto bg-white"
                        style="max-height: 400px;">
                        <div class="p-4 text-gray-500 text-center">Loading...</div>
                    </div>
                </div>

                <!-- Create New Folder Section -->
                <div class="border-t pt-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Create New Folder</h3>
                    <div class="flex gap-2">
                        <input type="text" id="new-folder-name" placeholder="Folder name"
                            class="flex-1 border border-gray-300 rounded px-3 py-2">
                        <button onclick="createNewFolder()"
                            class="bg-green-500 hover:bg-green-600 text-white font-semibold px-4 py-2 rounded whitespace-nowrap">
                            Create Folder
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Only letters, numbers, underscores, and hyphens allowed</p>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex justify-end gap-3 p-6 border-t">
                <button onclick="closeDirectoryBrowser()"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold px-4 py-2 rounded">
                    Cancel
                </button>
                <button onclick="selectCurrentDirectory()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded">
                    Select This Directory
                </button>
            </div>
        </div>
    </div>

    <!-- Database Cleanup Modal -->
    <div id="cleanup-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Database Clean-Up</h3>
                <button onclick="closeCleanupModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    &times;
                </button>
            </div>

            <div id="cleanup-step-1" class="space-y-4">
                <p class="text-gray-700">
                    Remove old recording entries to free up database space.
                </p>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Delete entries older than:
                    </label>
                    <select id="cleanup-months" class="w-full border border-gray-300 rounded px-3 py-2">
                        <option value="1">1 month</option>
                        <option value="3" selected>3 months</option>
                        <option value="6">6 months</option>
                        <option value="12">12 months</option>
                        <option value="24">24 months</option>
                    </select>
                </div>

                <div class="bg-gray-50 p-3 rounded text-sm">
                    <p class="font-medium mb-1">Will delete:</p>
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                        <li>Completed one-time recordings</li>
                        <li>Failed one-time recordings</li>
                        <li>Past instances from recurring recordings</li>
                        <li>Cancelled or missed recordings</li>
                    </ul>
                    <p class="mt-2 text-xs text-gray-600">
                        <strong>Note:</strong> Recurring recording patterns are preserved.
                    </p>
                </div>

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="closeCleanupModal()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">
                        Cancel
                    </button>
                    <button onclick="previewCleanup()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Preview
                    </button>
                </div>
            </div>

            <div id="cleanup-step-2" class="hidden space-y-4">
                <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
                    <p class="font-semibold text-yellow-900 mb-2">Deletion Preview</p>
                    <div class="text-sm space-y-1">
                        <p>Cutoff date: <strong id="preview-cutoff-date"></strong></p>
                        <p>One-time jobs to delete: <strong id="preview-jobs-count"></strong></p>
                        <p>Recording instances to delete: <strong id="preview-instances-count"></strong></p>
                        <p class="pt-2 border-t border-yellow-300">
                            Total entries: <strong id="preview-total-count" class="text-lg"></strong>
                        </p>
                    </div>
                </div>

                <p class="text-red-600 font-semibold text-sm">
                    ⚠️ This action cannot be undone!
                </p>

                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button onclick="backToStep1()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">
                        Back
                    </button>
                    <button onclick="executeCleanup()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                        Delete Now
                    </button>
                </div>
            </div>

            <div id="cleanup-step-3" class="hidden space-y-4">
                <div class="text-center">
                    <div class="text-green-600 text-5xl mb-3">✓</div>
                    <h4 class="text-lg font-semibold mb-2">Cleanup Complete</h4>
                    <div class="text-sm space-y-1 text-gray-700">
                        <p>Deleted <strong id="result-jobs-count"></strong> one-time jobs</p>
                        <p>Deleted <strong id="result-instances-count"></strong> recording instances</p>
                    </div>
                </div>

                <div class="flex justify-center pt-4 border-t">
                    <button onclick="closeCleanupModal(); location.reload();" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">
                        Done
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_scripts %}
    <script>
        let availableDevices = [];

        // Update current date/time display
        function updateDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            document.getElementById('current-datetime').textContent =
                now.toLocaleString('en-US', options);
        }

        // Update immediately and then every second
        updateDateTime();
        setInterval(updateDateTime, 1000);

        // Disk space monitoring
        async function updateDiskSpace() {
            try {
                const response = await fetch('/api/system/disk');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('disk-text').textContent = 'Disk: Error';
                    const mobileText = document.getElementById('disk-text-mobile');
                    if (mobileText) mobileText.textContent = 'Disk: Error';
                    return;
                }

                const diskSpace = document.getElementById('disk-space');
                const diskText = document.getElementById('disk-text');
                const diskSpaceMobile = document.getElementById('disk-space-mobile');
                const diskTextMobile = document.getElementById('disk-text-mobile');

                // Format display: "X.X GB / Y.Y GB"
                const displayText = `${data.used_gb} / ${data.total_gb} GB`;
                diskText.textContent = displayText;
                if (diskTextMobile) diskTextMobile.textContent = displayText;

                // Set title with more details
                diskSpace.title = `Used: ${data.used_gb} GB of ${data.total_gb} GB (${data.percent_used}%)\n` +
                    `Free: ${data.free_gb} GB\n` +
                    `Recording time remaining: ~${data.hours_remaining} hours`;

                // Determine class based on warning state
                let className = 'text-sm font-mono bg-blue-700 px-3 py-1 rounded cursor-pointer';
                if (data.low_space_warning || data.scheduled_warning) {
                    className = 'text-sm font-mono bg-red-600 px-3 py-1 rounded cursor-pointer animate-pulse';
                } else if (data.hours_remaining < 24) {
                    className = 'text-sm font-mono bg-yellow-600 px-3 py-1 rounded cursor-pointer';
                }

                diskSpace.className = className;
                if (diskSpaceMobile) diskSpaceMobile.className = className;

            } catch (error) {
                console.error('Error fetching disk space:', error);
                document.getElementById('disk-text').textContent = 'Disk: --';
                const mobileText = document.getElementById('disk-text-mobile');
                if (mobileText) mobileText.textContent = 'Disk: --';
            }
        }

        // Update disk space immediately and every 30 seconds
        updateDiskSpace();
        setInterval(updateDiskSpace, 30000);

        // Load on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadCurrentConfig();
            loadDevices();
            loadLogPaths();
            loadLogs();
            loadCameraConfig();
        });

        async function loadCurrentConfig() {
            try {
                const response = await fetch('/api/audio/config');
                const data = await response.json();
                
                // Update display
                const mode = data.current_device === 'auto' ? 'Auto-detect' : 'Manual';
                document.getElementById('current-mode').textContent = mode;
                document.getElementById('current-device').textContent = data.actual_device;
                
                if (data.device_info) {
                    document.getElementById('current-device').textContent = 
                        `${data.device_info.name} (${data.actual_device})`;
                    document.getElementById('device-status').innerHTML = 
                        '<span class="text-green-600">● Connected</span>';
                } else {
                    document.getElementById('device-status').innerHTML = 
                        '<span class="text-red-600">● Not Found</span>';
                }
                
                // Set radio buttons
                if (data.current_device === 'auto') {
                    document.getElementById('mode-auto').checked = true;
                } else {
                    document.getElementById('mode-manual').checked = true;
                    toggleDeviceMode();
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }

        async function loadDevices() {
            try {
                const response = await fetch('/api/audio/devices');
                const data = await response.json();
                availableDevices = data.devices;
                
                const select = document.getElementById('device-select');
                select.innerHTML = '';
                
                if (data.devices.length === 0) {
                    select.innerHTML = '<option value="">No devices found</option>';
                    return;
                }
                
                data.devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.alsa_id;
                    option.textContent = `${device.name} (${device.alsa_id})`;
                    if (device.is_recommended) {
                        option.textContent += ' ⭐ Recommended';
                    }
                    if (device.alsa_id === data.actual_device) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                // Update device info when selection changes
                select.addEventListener('change', updateDeviceInfo);
                updateDeviceInfo();
                
            } catch (error) {
                console.error('Error loading devices:', error);
            }
        }

        function toggleDeviceMode() {
            const manualMode = document.getElementById('mode-manual').checked;
            const manualSelect = document.getElementById('manual-device-select');
            manualSelect.classList.toggle('hidden', !manualMode);
        }

        function updateDeviceInfo() {
            const select = document.getElementById('device-select');
            const selectedId = select.value;
            const device = availableDevices.find(d => d.alsa_id === selectedId);
            const infoDiv = document.getElementById('device-info');
            
            if (device) {
                infoDiv.classList.remove('hidden');
                infoDiv.innerHTML = `
                    <p class="text-sm"><strong>Device:</strong> ${device.name}</p>
                    <p class="text-sm"><strong>Description:</strong> ${device.description}</p>
                    <p class="text-sm"><strong>ALSA ID:</strong> ${device.alsa_id}</p>
                    <p class="text-sm"><strong>Card:</strong> ${device.card}, <strong>Device:</strong> ${device.device}</p>
                    ${device.is_recommended ? '<p class="text-sm text-blue-600">⭐ Recommended for this system</p>' : ''}
                `;
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        async function testAudioDevice() {
            const autoMode = document.getElementById('mode-auto').checked;
            const device = autoMode ? 'auto' : document.getElementById('device-select').value;
            
            if (!autoMode && !device) {
                alert('Please select a device first');
                return;
            }
            
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing... (3 sec)';
            
            try {
                const response = await fetch('/api/audio/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device, duration: 3 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`✓ Audio test successful!\n\nDevice: ${result.device}\nFile size: ${result.file_size_mb} MB`);
                } else {
                    alert(`✗ Audio test failed:\n\n${result.error}`);
                }
            } catch (error) {
                alert('Error testing device: ' + error);
            } finally {
                button.disabled = false;
                button.textContent = 'Test Selected Device (3 sec)';
            }
        }

        async function saveAudioConfig() {
            const autoMode = document.getElementById('mode-auto').checked;
            const device = autoMode ? 'auto' : document.getElementById('device-select').value;
            
            if (!autoMode && !device) {
                alert('Please select a device first');
                return;
            }
            
            try {
                const response = await fetch('/api/audio/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Configuration saved successfully!\n\nChanges will take effect for new recordings.');
                    loadCurrentConfig();
                } else {
                    alert('✗ Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving configuration: ' + error);
            }
        }

        function refreshDevices() {
            loadDevices();
            loadCurrentConfig();
        }

        // Log file paths cache
        let logPaths = {};

        async function loadLogPaths() {
            try {
                const response = await fetch('/api/logs/paths');
                logPaths = await response.json();
                updateLogPath();
            } catch (error) {
                console.error('Error loading log paths:', error);
            }
        }

        function updateLogPath() {
            const logType = document.getElementById('log-type').value;
            const pathSpan = document.getElementById('current-log-path');

            if (logPaths[logType]) {
                pathSpan.textContent = logPaths[logType];
            } else {
                pathSpan.textContent = '(path not available)';
            }
        }

        async function loadLogs() {
            const logType = document.getElementById('log-type').value;
            const lines = document.getElementById('log-lines').value;

            try {
                const response = await fetch(`/api/logs?type=${logType}&lines=${lines}`);
                const data = await response.json();

                const container = document.getElementById('log-container');

                if (data.logs && data.logs.length > 0) {
                    container.innerHTML = data.logs.map(line =>
                        `<div>${escapeHtml(line)}</div>`
                    ).join('');

                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;

                    document.getElementById('log-info').textContent =
                        `Showing ${data.showing_lines} of ${data.total_lines} total lines`;
                } else {
                    container.innerHTML = '<div class="text-gray-500">No logs available</div>';
                    document.getElementById('log-info').textContent = 'No logs found';
                }

                // Update the file path display
                if (data.file_path) {
                    document.getElementById('current-log-path').textContent = data.file_path;
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('log-container').innerHTML =
                    '<div class="text-red-500">Error loading logs</div>';
            }
        }

        // Filename Configuration Functions
        async function loadFilenameConfig() {
            try {
                const response = await fetch('/api/config/filename');
                const data = await response.json();
                
                document.getElementById('left-suffix').value = data.left_suffix || 'L';
                document.getElementById('right-suffix').value = data.right_suffix || 'R';
                
                updateFilenamePreview();
            } catch (error) {
                console.error('Error loading filename config:', error);
            }
        }

        function updateFilenamePreview() {
            const now = new Date();
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const year = now.getFullYear();
            const month = months[now.getMonth()];
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const leftSuffix = document.getElementById('left-suffix').value || 'L';
            const rightSuffix = document.getElementById('right-suffix').value || 'R';
            
            document.getElementById('filename-preview-left').textContent = 
                `${year}_${month}_${day}_${hours}:${minutes}_${leftSuffix}.wav`;
            document.getElementById('filename-preview-right').textContent = 
                `${year}_${month}_${day}_${hours}:${minutes}_${rightSuffix}.wav`;
        }

        // Update preview on input
        document.addEventListener('DOMContentLoaded', () => {
            loadFilenameConfig();
            loadStorageConfig();
            document.getElementById('left-suffix').addEventListener('input', updateFilenamePreview);
            document.getElementById('right-suffix').addEventListener('input', updateFilenamePreview);
        });

        async function saveFilenameConfig() {
            const leftSuffix = document.getElementById('left-suffix').value.trim();
            const rightSuffix = document.getElementById('right-suffix').value.trim();
            
            if (!leftSuffix || !rightSuffix) {
                alert('Both channel suffixes are required');
                return;
            }
            
            if (leftSuffix === rightSuffix) {
                if (!confirm('Warning: Left and right channel suffixes are the same. This may cause confusion. Continue anyway?')) {
                    return;
                }
            }
            
            try {
                const response = await fetch('/api/config/filename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        left_suffix: leftSuffix,
                        right_suffix: rightSuffix
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Filename configuration saved successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving filename configuration: ' + error);
            }
        }

        // Storage Path Configuration Functions
        async function loadStorageConfig() {
            try {
                const response = await fetch('/api/config/storage');
                const data = await response.json();

                document.getElementById('storage-path').value = data.storage_path || '/mnt/usb_recorder';

                const statusText = document.getElementById('storage-status-text');
                if (data.exists && data.is_writable) {
                    statusText.innerHTML = '<span class="text-green-600">Path exists and is writable</span>';
                } else if (data.exists) {
                    statusText.innerHTML = '<span class="text-yellow-600">Path exists but may not be writable</span>';
                } else {
                    statusText.innerHTML = '<span class="text-red-600">Path does not exist (will be created on save)</span>';
                }
            } catch (error) {
                console.error('Error loading storage config:', error);
            }
        }

        async function saveStorageConfig() {
            const storagePath = document.getElementById('storage-path').value.trim();

            if (!storagePath) {
                alert('Storage path is required');
                return;
            }

            try {
                const response = await fetch('/api/config/storage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ storage_path: storagePath })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Storage location saved successfully!');
                    loadStorageConfig();  // Refresh status
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error saving storage location: ' + error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Backup/Restore Functions
        async function checkRevertAvailable() {
            try {
                const response = await fetch('/api/revert/available');
                const data = await response.json();
                
                const schedulesBtn = document.getElementById('revert-schedules-btn');
                const configBtn = document.getElementById('revert-config-btn');
                
                if (data.schedules_available) {
                    schedulesBtn.disabled = false;
                    schedulesBtn.className = 'bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded cursor-pointer';
                }
                
                if (data.config_available) {
                    configBtn.disabled = false;
                    configBtn.className = 'bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded cursor-pointer';
                }
            } catch (error) {
                console.error('Error checking revert availability:', error);
            }
        }

        // Check revert availability on page load
        checkRevertAvailable();

        function exportSchedules() {
            window.location.href = '/api/export/schedules';
        }

        function exportConfig() {
            window.location.href = '/api/export/config';
        }

        async function importSchedules() {
            const fileInput = document.getElementById('schedules-file');
            if (!fileInput.files.length) {
                alert('Please select a .sched file first');
                return;
            }
            
            if (!confirm('WARNING: This will overwrite all current schedules and templates!\n\nCurrent data will be backed up automatically.\n\nAre you sure you want to continue?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch('/api/import/schedules', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Schedules imported successfully!\n\nPrevious schedules backed up. Use Revert button if needed.');
                    fileInput.value = '';
                    checkRevertAvailable();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error importing schedules: ' + error);
            }
        }

        async function importConfig() {
            const fileInput = document.getElementById('config-file');
            if (!fileInput.files.length) {
                alert('Please select a .conf file first');
                return;
            }
            
            if (!confirm('WARNING: This will overwrite all current configuration!\n\nCurrent configuration will be backed up automatically.\n\nAre you sure you want to continue?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch('/api/import/config', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Configuration imported successfully!\n\nPrevious configuration backed up. Use Revert button if needed.');
                    fileInput.value = '';
                    checkRevertAvailable();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error importing configuration: ' + error);
            }
        }

        async function revertSchedules() {
            if (!confirm('Revert to previous schedules?\n\nThis will restore schedules from before your last import.\n\nCurrent schedules will be lost!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/revert/schedules', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Reverted to previous schedules!');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error reverting: ' + error);
            }
        }

        async function revertConfig() {
            if (!confirm('Revert to previous configuration?\n\nThis will restore configuration from before your last import.\n\nCurrent configuration will be lost!')) {
                return;
            }
            
            try {
                const response = await fetch('/api/revert/config', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✓ Reverted to previous configuration!');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Error reverting: ' + error);
            }
        }

        // Auto-refresh logs every 5 seconds
        setInterval(loadLogs, 5000);

        // ============================================================================
        // Camera Configuration Functions
        // ============================================================================

        let cameraPresetNames = {};

        async function loadCameraConfig() {
            try {
                const response = await fetch('/api/camera/config');
                const config = await response.json();

                document.getElementById('camera-ip').value = config.camera_ip || '';
                document.getElementById('camera-username').value = config.camera_username || '';

                // Don't show actual password, just indicate if one is set
                if (config.camera_password && config.camera_password !== '') {
                    document.getElementById('camera-password').placeholder = '(password set)';
                }

                cameraPresetNames = config.preset_names || {};
                renderPresetNameInputs();

            } catch (error) {
                console.error('Error loading camera config:', error);
            }
        }

        function renderPresetNameInputs() {
            const grid = document.getElementById('preset-names-grid');
            grid.innerHTML = '';

            for (let i = 1; i <= 10; i++) {
                const div = document.createElement('div');
                div.innerHTML = `
                    <label class="block text-xs text-gray-600 mb-1">Preset ${i}</label>
                    <input type="text" id="preset-name-${i}"
                        value="${cameraPresetNames[i] || ''}"
                        placeholder="Preset ${i}"
                        class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                `;
                grid.appendChild(div);
            }
        }

        async function testCameraConnection() {
            const statusSpan = document.getElementById('camera-connection-status');
            statusSpan.textContent = 'Testing...';
            statusSpan.className = 'text-blue-600';

            // First save the config temporarily
            await saveCameraConfig(true);

            try {
                const response = await fetch('/api/camera/test', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    statusSpan.textContent = 'Connected successfully';
                    statusSpan.className = 'text-green-600';
                } else {
                    statusSpan.textContent = 'Connection failed: ' + result.error;
                    statusSpan.className = 'text-red-600';
                }
            } catch (error) {
                statusSpan.textContent = 'Error: ' + error;
                statusSpan.className = 'text-red-600';
            }
        }

        async function saveCameraConfig(silent = false) {
            const cameraIp = document.getElementById('camera-ip').value.trim();
            const cameraUsername = document.getElementById('camera-username').value.trim();
            const cameraPassword = document.getElementById('camera-password').value;

            // Collect preset names
            const presetNames = {};
            for (let i = 1; i <= 10; i++) {
                const input = document.getElementById(`preset-name-${i}`);
                if (input && input.value.trim()) {
                    presetNames[i] = input.value.trim();
                }
            }

            const configData = {
                camera_ip: cameraIp,
                camera_username: cameraUsername,
                preset_names: presetNames
            };

            // Only include password if it was changed
            if (cameraPassword && cameraPassword !== '') {
                configData.camera_password = cameraPassword;
            }

            try {
                const response = await fetch('/api/camera/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData)
                });

                const result = await response.json();

                if (result.success) {
                    if (!silent) {
                        alert('Camera configuration saved successfully!');
                    }
                    // Clear password field after save
                    document.getElementById('camera-password').value = '';
                    document.getElementById('camera-password').placeholder = cameraPassword ? '(password set)' : '********';
                } else {
                    if (!silent) {
                        alert('Error: ' + result.error);
                    }
                }

                return result.success;
            } catch (error) {
                if (!silent) {
                    alert('Error saving camera configuration: ' + error);
                }
                return false;
            }
        }

        // ============================================================
        // Directory Browser Functions
        // ============================================================

        // State variable for current browser path
        let currentBrowserPath = '/';

        /**
         * Open the directory browser modal
         * Initialize from current input value or default to '/'
         */
        function openDirectoryBrowser() {
            const modal = document.getElementById('directory-browser-modal');
            const currentPath = document.getElementById('storage-path').value.trim() || '/';

            // Show modal
            modal.classList.remove('hidden');

            // Load initial directory
            loadDirectoryContents(currentPath);
        }

        /**
         * Close the directory browser modal
         * Clear the new folder input
         */
        function closeDirectoryBrowser() {
            const modal = document.getElementById('directory-browser-modal');
            modal.classList.add('hidden');

            // Clear new folder input
            document.getElementById('new-folder-name').value = '';
        }

        /**
         * Select the current directory and update the storage-path input
         */
        function selectCurrentDirectory() {
            const storagePathInput = document.getElementById('storage-path');
            storagePathInput.value = currentBrowserPath;
            closeDirectoryBrowser();
        }

        /**
         * Load directory contents from the API
         * @param {string} path - Path to load
         */
        async function loadDirectoryContents(path) {
            const directoryList = document.getElementById('directory-list');

            // Show loading state
            directoryList.innerHTML = '<div class="p-4 text-gray-500 text-center">Loading...</div>';

            try {
                const response = await fetch('/api/directories/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: path })
                });

                const result = await response.json();

                if (result.success) {
                    currentBrowserPath = result.current_path;
                    updateBrowserUI(result);
                } else {
                    directoryList.innerHTML = `<div class="p-4 text-red-600 text-center">Error: ${escapeHtml(result.error)}</div>`;
                }
            } catch (error) {
                directoryList.innerHTML = `<div class="p-4 text-red-600 text-center">Error loading directories: ${escapeHtml(error.toString())}</div>`;
            }
        }

        /**
         * Update the browser UI with directory data
         * @param {Object} data - API response data
         */
        function updateBrowserUI(data) {
            const directoryList = document.getElementById('directory-list');
            const currentPathInput = document.getElementById('browser-current-path');

            // Update current path display
            currentPathInput.value = data.current_path;

            // Update breadcrumbs
            updateBreadcrumbs(data.current_path);

            // Build directory list HTML
            let html = '';

            // Add parent directory link if not at root
            if (data.parent_path) {
                html += `
                    <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b flex items-center gap-2"
                        onclick="loadDirectoryContents('${escapeHtml(data.parent_path)}')">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        <span class="font-semibold text-gray-700">..</span>
                        <span class="text-sm text-gray-500">(Parent Directory)</span>
                    </div>
                `;
            }

            // Add directories
            if (data.directories.length === 0) {
                if (!data.parent_path) {
                    html = '<div class="p-4 text-gray-500 text-center">No directories found</div>';
                }
            } else {
                data.directories.forEach(dir => {
                    const writableIndicator = dir.writable ? '' : '<span class="text-xs text-red-500">(read-only)</span>';
                    html += `
                        <div class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b flex items-center gap-2"
                            onclick="loadDirectoryContents('${escapeHtml(dir.path)}')">
                            <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                            </svg>
                            <span class="text-gray-800">${escapeHtml(dir.name)}</span>
                            ${writableIndicator}
                        </div>
                    `;
                });
            }

            directoryList.innerHTML = html;
        }

        /**
         * Update breadcrumb navigation
         * @param {string} path - Current path
         */
        function updateBreadcrumbs(path) {
            const breadcrumbsContainer = document.getElementById('browser-breadcrumbs');

            // Split path into segments
            const segments = path.split('/').filter(s => s.length > 0);

            let html = `
                <button onclick="loadDirectoryContents('/')"
                    class="px-2 py-1 rounded hover:bg-gray-200 text-blue-600 font-semibold">
                    /
                </button>
            `;

            let currentPath = '';
            segments.forEach((segment, index) => {
                currentPath += '/' + segment;
                const pathForClick = currentPath;

                html += `
                    <span class="text-gray-400">/</span>
                    <button onclick="loadDirectoryContents('${escapeHtml(pathForClick)}')"
                        class="px-2 py-1 rounded hover:bg-gray-200 text-blue-600">
                        ${escapeHtml(segment)}
                    </button>
                `;
            });

            breadcrumbsContainer.innerHTML = html;
        }

        /**
         * Create a new folder in the current directory
         */
        async function createNewFolder() {
            const folderNameInput = document.getElementById('new-folder-name');
            const folderName = folderNameInput.value.trim();

            if (!folderName) {
                alert('Please enter a folder name');
                return;
            }

            // Validate folder name on client side
            const validPattern = /^[a-zA-Z0-9_\-]+$/;
            if (!validPattern.test(folderName)) {
                alert('Folder name can only contain letters, numbers, underscores, and hyphens');
                return;
            }

            try {
                const response = await fetch('/api/directories/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parent_path: currentBrowserPath,
                        folder_name: folderName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Folder created successfully: ' + result.name);
                    folderNameInput.value = '';
                    // Reload directory to show new folder
                    loadDirectoryContents(currentBrowserPath);
                } else {
                    alert('Error creating folder: ' + result.error);
                }
            } catch (error) {
                alert('Error creating folder: ' + error);
            }
        }

        /**
         * HTML escape utility function for safe rendering
         * @param {string} text - Text to escape
         * @returns {string} - Escaped text
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Database Cleanup Functions
        function openCleanupModal() {
            document.getElementById('cleanup-modal').classList.remove('hidden');
            document.getElementById('cleanup-step-1').classList.remove('hidden');
            document.getElementById('cleanup-step-2').classList.add('hidden');
            document.getElementById('cleanup-step-3').classList.add('hidden');
        }

        function closeCleanupModal() {
            document.getElementById('cleanup-modal').classList.add('hidden');
        }

        async function previewCleanup() {
            const monthsOld = parseInt(document.getElementById('cleanup-months').value);

            try {
                const response = await fetch('/api/schedule/cleanup/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ months_old: monthsOld })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert('Error: ' + (data.error || 'Preview failed'));
                    return;
                }

                // Populate preview
                document.getElementById('preview-cutoff-date').textContent = data.preview.cutoff_date;
                document.getElementById('preview-jobs-count').textContent = data.preview.jobs_count;
                document.getElementById('preview-instances-count').textContent = data.preview.instances_count;
                document.getElementById('preview-total-count').textContent = data.preview.total_count;

                // Show step 2
                document.getElementById('cleanup-step-1').classList.add('hidden');
                document.getElementById('cleanup-step-2').classList.remove('hidden');
            } catch (error) {
                alert('Error fetching preview: ' + error);
            }
        }

        function backToStep1() {
            document.getElementById('cleanup-step-2').classList.add('hidden');
            document.getElementById('cleanup-step-1').classList.remove('hidden');
        }

        async function executeCleanup() {
            const monthsOld = parseInt(document.getElementById('cleanup-months').value);

            try {
                const response = await fetch('/api/schedule/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        months_old: monthsOld,
                        confirm: true
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert('Error: ' + (data.error || 'Cleanup failed'));
                    return;
                }

                // Show results
                document.getElementById('result-jobs-count').textContent = data.jobs_deleted;
                document.getElementById('result-instances-count').textContent = data.instances_deleted;

                // Show step 3
                document.getElementById('cleanup-step-2').classList.add('hidden');
                document.getElementById('cleanup-step-3').classList.remove('hidden');
            } catch (error) {
                alert('Error executing cleanup: ' + error);
            }
        }
    </script>
</body>
</html>
{% endblock %}
