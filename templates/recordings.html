{% extends "base.html" %}

{% block title %}Church Recording - Recordings{% endblock %}

{% block page_subtitle %}Recordings{% endblock %}

{% block content %}
    <div class="container mx-auto p-6">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                <h2 class="text-lg sm:text-xl font-semibold">Recorded Files</h2>
                <div class="flex flex-wrap items-center gap-2 sm:gap-4">
                    <div id="batch-actions" class="hidden flex flex-wrap items-center gap-2">
                        <span id="selected-count" class="text-xs sm:text-sm text-gray-600">0 selected</span>
                        <button onclick="batchDownload()"
                            class="bg-green-500 hover:bg-green-600 text-white text-xs sm:text-sm px-2 sm:px-3 py-1 rounded">
                            Download
                        </button>
                        <button onclick="batchDelete()"
                            class="bg-red-500 hover:bg-red-600 text-white text-xs sm:text-sm px-2 sm:px-3 py-1 rounded">
                            Delete
                        </button>
                    </div>
                    <div class="text-xs sm:text-sm text-gray-600">
                        Total: <span id="file-count">{{ files|length }}</span> files
                    </div>
                </div>
            </div>

            {% if files %}
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left p-3 text-gray-700 w-10">
                                <input type="checkbox" id="select-all" onchange="toggleSelectAll()"
                                    class="w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </th>
                            <th class="text-left p-3 text-gray-700">Filename</th>
                            <th class="text-left p-3 text-gray-700">Size</th>
                            <th class="text-left p-3 text-gray-700">Modified</th>
                            <th class="text-left p-3 text-gray-700">Type</th>
                            <th class="text-right p-3 text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in files %}
                        <tr class="border-b border-gray-100 hover:bg-gray-50" id="file-row-{{ loop.index }}" data-filename="{{ file.name }}">
                            <td class="p-3">
                                <input type="checkbox" class="file-checkbox w-4 h-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    data-filename="{{ file.name }}" onchange="updateSelection()">
                            </td>
                            <td class="p-3 relative">
                                <span class="font-mono text-sm cursor-help group relative"
                                      data-filename="{{ file.name }}"
                                      onmouseenter="loadAnalysisTooltip('{{ file.name }}', this)"
                                      onmouseleave="hideTooltip(this)">
                                    {{ file.name }}

                                    <!-- Tooltip container (hidden by default) -->
                                    <div class="tooltip-popup hidden absolute left-0 top-full mt-2 bg-gray-900 text-white text-xs rounded-lg p-3 shadow-xl z-50 min-w-[300px]">
                                        <div class="tooltip-loading">Loading analysis...</div>
                                        <div class="tooltip-content hidden"></div>
                                        <div class="tooltip-error hidden text-red-300"></div>
                                        <!-- Pointer arrow -->
                                        <div class="absolute bottom-full left-4 border-4 border-transparent border-b-gray-900"></div>
                                    </div>
                                </span>
                            </td>
                            <td class="p-3 text-gray-600">
                                {{ file.size_mb }} MB
                            </td>
                            <td class="p-3 text-gray-600">
                                {{ file.modified[:10] }} {{ file.modified[11:19] }}
                            </td>
                            <td class="p-3">
                                <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">
                                    {{ file.type }}
                                </span>
                            </td>
                            <td class="p-3 text-right space-x-2">
                                <a href="/api/recordings/{{ file.name }}" download
                                    class="inline-block bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-1 rounded">
                                    Download
                                </a>
                                <button onclick="deleteFile('{{ file.name }}', {{ loop.index }})"
                                    class="bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-1 rounded">
                                    Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded">
                <h3 class="font-semibold text-blue-900 mb-2">Storage Info</h3>
                <p class="text-sm text-blue-800">
                    Recordings are stored in: <code class="bg-blue-100 px-2 py-1 rounded">/home/pi/recordings/</code>
                </p>
                <p class="text-sm text-blue-800 mt-1">
                    Total files size: <strong>{{ (files | map(attribute='size') | sum / 1024 / 1024) | round(2) }} MB</strong>
                </p>
            </div>

            {% else %}
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="mt-2 text-lg font-medium text-gray-900">No recordings yet</h3>
                <p class="mt-1 text-gray-500">Start a recording to see files here</p>
                <div class="mt-6">
                    <a href="/" class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded">
                        Go to Dashboard
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Video Files Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-lg sm:text-xl font-semibold mb-4">Video Files</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Raw Files -->
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Raw Recordings (Pending Processing)</h3>
                    <div id="raw-files-list" class="border rounded max-h-64 overflow-y-auto">
                        <p class="p-3 text-gray-500 text-sm">Loading...</p>
                    </div>
                </div>

                <!-- Processed Files -->
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">Processed Videos</h3>
                    <div id="processed-files-list" class="border rounded max-h-64 overflow-y-auto">
                        <p class="p-3 text-gray-500 text-sm">Loading...</p>
                    </div>
                </div>
            </div>

            <div class="mt-4 p-4 bg-gray-50 border rounded text-sm">
                <strong>Video Storage:</strong>
                <span id="video-storage-status">Checking...</span>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
    <script>
        // Selection management
        function getSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.filename);
        }

        function updateSelection() {
            const selected = getSelectedFiles();
            const batchActions = document.getElementById('batch-actions');
            const selectedCount = document.getElementById('selected-count');
            const selectAll = document.getElementById('select-all');
            const allCheckboxes = document.querySelectorAll('.file-checkbox');

            if (selected.length > 0) {
                batchActions.classList.remove('hidden');
                selectedCount.textContent = `${selected.length} selected`;
            } else {
                batchActions.classList.add('hidden');
            }

            // Update select-all checkbox state
            if (allCheckboxes.length > 0) {
                selectAll.checked = selected.length === allCheckboxes.length;
                selectAll.indeterminate = selected.length > 0 && selected.length < allCheckboxes.length;
            }
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelection();
        }

        async function batchDownload() {
            const selected = getSelectedFiles();
            if (selected.length === 0) return;

            if (selected.length === 1) {
                // Single file - direct download
                window.location.href = `/api/recordings/${selected[0]}`;
                return;
            }

            // Multiple files - download as zip
            try {
                const response = await fetch('/api/recordings/batch/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: selected })
                });

                if (!response.ok) {
                    const result = await response.json();
                    alert('Error: ' + (result.error || 'Download failed'));
                    return;
                }

                // Download the zip file
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `recordings-${new Date().toISOString().slice(0,10)}.zip`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                alert('Error downloading files: ' + error);
            }
        }

        async function batchDelete() {
            const selected = getSelectedFiles();
            if (selected.length === 0) return;

            const confirmMsg = selected.length === 1
                ? `Delete ${selected[0]}?`
                : `Delete ${selected.length} selected files?`;

            if (!confirm(confirmMsg)) return;

            try {
                const response = await fetch('/api/recordings/batch/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ files: selected })
                });

                const result = await response.json();

                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    // Remove deleted rows from table
                    selected.forEach(filename => {
                        const row = document.querySelector(`tr[data-filename="${filename}"]`);
                        if (row) row.remove();
                    });

                    // Update file count
                    const countElem = document.getElementById('file-count');
                    const newCount = parseInt(countElem.textContent) - selected.length;
                    countElem.textContent = newCount;

                    // Reset selection UI
                    document.getElementById('select-all').checked = false;
                    updateSelection();

                    // Reload if no files left
                    if (newCount === 0) {
                        location.reload();
                    }
                }
            } catch (error) {
                alert('Error deleting files: ' + error);
            }
        }

        async function deleteFile(filename, rowIndex) {
            if (!confirm(`Delete ${filename}?`)) return;

            try {
                const response = await fetch(`/api/recordings/${filename}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    // Remove row from table
                    document.getElementById(`file-row-${rowIndex}`).remove();

                    // Update file count
                    const countElem = document.getElementById('file-count');
                    countElem.textContent = parseInt(countElem.textContent) - 1;

                    // Reload if no files left
                    if (parseInt(countElem.textContent) === 0) {
                        location.reload();
                    }
                }
            } catch (error) {
                alert('Error deleting file: ' + error);
            }
        }

        // Video files loading
        async function loadVideoFiles() {
            try {
                const response = await fetch('/api/video/files');
                const files = await response.json();

                // Render raw files
                const rawList = document.getElementById('raw-files-list');
                if (files.raw && files.raw.length > 0) {
                    rawList.innerHTML = files.raw.map(f => `
                        <div class="p-2 border-b last:border-b-0 text-sm">
                            <div class="font-medium">${f.name}</div>
                            <div class="text-gray-500">${f.size_mb} MB</div>
                        </div>
                    `).join('');
                } else {
                    rawList.innerHTML = '<p class="p-3 text-gray-500 text-sm">No raw files</p>';
                }

                // Render processed files
                const processedList = document.getElementById('processed-files-list');
                if (files.processed && files.processed.length > 0) {
                    processedList.innerHTML = files.processed.map(f => `
                        <div class="p-2 border-b last:border-b-0 text-sm">
                            <div class="font-medium">${f.name}</div>
                            <div class="text-gray-500">${f.size_mb} MB</div>
                        </div>
                    `).join('');
                } else {
                    processedList.innerHTML = '<p class="p-3 text-gray-500 text-sm">No processed files</p>';
                }

            } catch (error) {
                console.error('Error loading video files:', error);
                document.getElementById('raw-files-list').innerHTML = '<p class="p-3 text-red-500 text-sm">Error loading files</p>';
                document.getElementById('processed-files-list').innerHTML = '<p class="p-3 text-red-500 text-sm">Error loading files</p>';
            }
        }

        // Video storage status
        async function updateVideoStorage() {
            try {
                const response = await fetch('/api/video/storage');
                const info = await response.json();
                const statusEl = document.getElementById('video-storage-status');

                if (info.mounted) {
                    statusEl.innerHTML = `${info.free_gb} GB free (~${info.hours_remaining} hrs recording)`;
                    statusEl.className = info.hours_remaining < 2 ? 'text-red-600' : 'text-green-600';
                } else {
                    statusEl.innerHTML = '<span class="text-red-600">USB storage not mounted</span>';
                }
            } catch (error) {
                document.getElementById('video-storage-status').innerHTML = '<span class="text-yellow-600">Not configured</span>';
            }
        }

        // Load video files on page load
        loadVideoFiles();
        updateVideoStorage();
        setInterval(loadVideoFiles, 10000);

        // Audio Analysis Tooltip Functions
        // Cache for analysis results (avoid repeated API calls)
        const analysisCache = {};

        async function loadAnalysisTooltip(filename, element) {
            const tooltip = element.querySelector('.tooltip-popup');
            const loading = tooltip.querySelector('.tooltip-loading');
            const content = tooltip.querySelector('.tooltip-content');
            const error = tooltip.querySelector('.tooltip-error');

            // Show tooltip
            tooltip.classList.remove('hidden');

            // Check cache first
            if (analysisCache[filename]) {
                displayAnalysis(analysisCache[filename], content, loading, error);
                return;
            }

            // Fetch analysis from API
            try {
                const response = await fetch(`/api/recordings/${encodeURIComponent(filename)}/analysis`);
                const data = await response.json();

                // Cache result
                analysisCache[filename] = data;

                displayAnalysis(data, content, loading, error);
            } catch (err) {
                loading.classList.add('hidden');
                error.textContent = 'Failed to load analysis';
                error.classList.remove('hidden');
            }
        }

        function displayAnalysis(data, content, loading, error) {
            loading.classList.add('hidden');

            if (!data.analyzed) {
                error.textContent = 'Analysis not available yet';
                error.classList.remove('hidden');
                return;
            }

            // Build tooltip content
            let html = '<div class="space-y-2">';

            data.channels.forEach(ch => {
                const channelLabel = ch.channel === 'left' ? 'Left Channel (L)' : 'Right Channel (R)';

                if (ch.status === 'failed') {
                    html += `<div class="border-b border-gray-700 pb-2">
                        <div class="font-semibold text-red-300">${channelLabel}: Analysis Failed</div>
                        <div class="text-red-200 text-xs">${ch.error_message || 'Unknown error'}</div>
                    </div>`;
                } else {
                    html += `<div class="border-b border-gray-700 pb-2 last:border-b-0">
                        <div class="font-semibold mb-1">${channelLabel}</div>
                        <div class="grid grid-cols-2 gap-x-3 gap-y-1">
                            <div class="text-gray-300">Duration:</div>
                            <div>${formatDuration(ch.total_duration)}</div>

                            <div class="text-gray-300">Non-silent:</div>
                            <div class="font-medium ${ch.non_silent_percentage < 50 ? 'text-yellow-300' : 'text-green-300'}">
                                ${ch.non_silent_percentage.toFixed(1)}%
                            </div>

                            <div class="text-gray-300">Mean dB:</div>
                            <div>${ch.mean_db.toFixed(1)} dB</div>

                            <div class="text-gray-300">Max dB:</div>
                            <div class="font-medium">${ch.max_db.toFixed(1)} dB</div>

                            <div class="text-gray-300">Max at:</div>
                            <div>${formatTime(ch.max_db_time)}</div>
                        </div>
                    </div>`;
                }
            });

            html += '</div>';

            content.innerHTML = html;
            content.classList.remove('hidden');
        }

        function hideTooltip(element) {
            const tooltip = element.querySelector('.tooltip-popup');
            setTimeout(() => {
                tooltip.classList.add('hidden');
            }, 200);  // Small delay to prevent flicker
        }

        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}m ${secs}s`;
        }
    </script>
{% endblock %}
